<!-- Glissando Suggestions Panel -->
<style>
    .glissando-panel {
        background: white;
        border: 2px solid #FFD700;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .glissando-panel h4 {
        margin: 0 0 12px 0;
        color: #008080;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .glissando-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 12px;
    }

    .gliss-btn {
        padding: 8px 14px;
        border: 2px solid #e1e8ed;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .gliss-btn.active {
        background: #FFD700;
        border-color: #FFD700;
        font-weight: 600;
    }

    .gliss-btn:hover {
        border-color: #FFD700;
        transform: translateY(-1px);
    }

    .glissando-info {
        background: #F5F5F5;
        padding: 10px 14px;
        border-radius: 6px;
        font-size: 0.9rem;
        color: #2C3E50;
        min-height: 50px;
    }

    .glissando-legend {
        display: flex;
        gap: 20px;
        margin: 10px 0;
        font-size: 0.85rem;
        flex-wrap: wrap;
    }

    .glissando-legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* SVG Marker styles */
    .glissando-marker {
        transition: all 0.2s;
    }

    .glissando-marker:hover {
        transform: scale(1.3);
    }
</style>

<div class="glissando-panel" style="border: none; background: transparent; padding: 0; margin: 8px 0;">
    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; font-size: 0.9rem;">
        <span style="font-weight: 600; color: #008080;">Perfect Glissando System</span>
        <button onclick="drawAllGlissandos()" style="padding: 4px 10px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Draw All</button>
        <button onclick="clearAllGlissandos()" style="padding: 4px 10px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Clear All</button>
        <div id="durationRadioButtons" style="display: flex; gap: 8px; align-items: center;">
            <!-- Checkboxes will be inserted here -->
        </div>
        <span id="glissandoInfo" style="color: #666; font-size: 0.85rem; margin-left: auto;">
            Select durations
        </span>
    </div>
</div>

<script>
// Glissando drawing state
let glissandosVisible = true;
let glissandosDrawn = false;

// Auto-load glissando analysis when page loads
document.addEventListener('DOMContentLoaded', async () => {
    // Wait a bit for page to fully load
    await new Promise(resolve => setTimeout(resolve, 500));

    // Try to get song name from page title or default
    const titleElement = document.querySelector('h1, .song-title');
    let songName = 'Bà rằng bà rí'; // default

    // Try various methods to get current song name
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('song')) {
        songName = urlParams.get('song');
    } else if (titleElement) {
        songName = titleElement.textContent.trim();
    }

    console.log(`Loading glissando analysis for song: "${songName}"`);

    try {
        // Initialize controller with optimal SVG
        const initialized = window.glissandoController.initialize('optimalSvg');

        if (!initialized) {
            throw new Error('Could not initialize glissando controller');
        }

        // Analyze SVG notes directly (no server call needed)
        window.glissandoController.analyzeSVGNotes();

        const candidates = window.glissandoController.glissandoCandidates;

        if (candidates && candidates.length > 0) {
            console.log(`Found ${candidates.length} glissando candidates from SVG`);

            // Group candidates by duration
            const durationGroups = {};
            candidates.forEach(c => {
                if (!durationGroups[c.duration]) {
                    durationGroups[c.duration] = [];
                }
                durationGroups[c.duration].push(c);
            });

            // Sort durations (longest first)
            const sortedDurations = Object.keys(durationGroups).map(parseFloat).sort((a, b) => b - a);

            // Create checkboxes for each duration (allow multiple selection)
            const radioContainer = document.getElementById('durationRadioButtons');
            radioContainer.innerHTML = sortedDurations.map((duration, index) => {
                const count = durationGroups[duration].length;
                const color = window.glissandoController.durationColorMap[duration] || '#95A5A6';
                const stats = window.glissandoController.durationStats[duration];
                const percentage = stats ? stats.percentage : '0.0';
                const beatLabel = duration === 1 ? 'beat' : 'beats';
                const colorName = color === '#FFD700' ? 'Gold' : color === '#3498DB' ? 'Blue' : color === '#9B59B6' ? 'Purple' : color === '#95A5A6' ? 'Grey' : color === '#E67E22' ? 'Orange' : 'Red';

                return `
                    <label title="${count} ${colorName.toLowerCase()} glissandos for ${duration}-beat notes (${percentage}% of song)"
                           style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                        <input type="checkbox" name="glissandoDuration" value="${duration}" onchange="toggleGlissandosByDuration(${duration}, this.checked)">
                        <span style="width: 10px; height: 10px; border-radius: 50%; background: ${color};"></span>
                        <span style="font-size: 0.85rem;">${duration}b (${count}, ${percentage}%)</span>
                    </label>
                `;
            }).join('');

            // Update info
            updateGlissandoInfo();

            // Enable draw button
            document.getElementById('drawAllGlissandosBtn').disabled = false;
        } else {
            console.warn('No glissando candidates found in SVG');
            document.getElementById('glissandoInfo').innerHTML = `
                <span style="color: #E67E22;">No glissando candidates found (no notes >= 1.5 beats).</span>
            `;
        }
    } catch (error) {
        console.error('Error analyzing glissando:', error);
        document.getElementById('glissandoInfo').innerHTML = `
            <span style="color: #E74C3C;">Error: ${error.message}</span>
        `;
    }
});

// Toggle glissandos for a specific duration
function toggleGlissandosByDuration(duration, isChecked) {
    try {
        // Get candidates with this duration
        const candidates = window.glissandoController.glissandoCandidates.filter(c => c.duration === duration);

        if (candidates.length === 0) {
            console.warn(`No candidates found for duration ${duration}`);
            return;
        }

        if (isChecked) {
            // Draw glissandos for this duration
            candidates.forEach(candidate => {
                window.glissandoController.drawGlissandoForCandidate(candidate.noteIndex);
            });
        } else {
            // Remove glissandos for this duration
            candidates.forEach(candidate => {
                window.glissandoController.removeGlissandoForNote(candidate.noteIndex);
            });
        }

        // Update info based on what's currently shown
        updateGlissandoInfo();

    } catch (error) {
        console.error('Error toggling glissandos:', error);
    }
}

// Update info panel based on active glissandos
function updateGlissandoInfo() {
    const activeCount = window.glissandoController.glissandoPaths.length;

    if (activeCount === 0) {
        document.getElementById('glissandoInfo').innerHTML = `
            Select duration checkboxes to draw glissandos.
        `;
    } else {
        // Count by color
        const colorCounts = {};
        window.glissandoController.glissandoPaths.forEach(path => {
            colorCounts[path.color] = (colorCounts[path.color] || 0) + 1;
        });

        const summary = Object.entries(colorCounts).map(([color, count]) => {
            const colorName = color === '#FFD700' ? 'Gold' : color === '#3498DB' ? 'Blue' : color === '#9B59B6' ? 'Purple' : 'Grey';
            return `<span style="color: ${color};">${count} ${colorName}</span>`;
        }).join(', ');

        document.getElementById('glissandoInfo').innerHTML = `
            <strong>${activeCount} glissandos</strong> drawn: ${summary}
        `;
    }
}

// Draw all glissando paths
function drawAllGlissandos() {
    try {
        // Check all checkboxes
        document.querySelectorAll('input[name="glissandoDuration"]').forEach(checkbox => {
            if (!checkbox.checked) {
                checkbox.checked = true;
                toggleGlissandosByDuration(parseFloat(checkbox.value), true);
            }
        });

        updateGlissandoInfo();
    } catch (error) {
        console.error('Error drawing glissandos:', error);
    }
}

// Clear all glissando paths
function clearAllGlissandos() {
    // Uncheck all checkboxes
    document.querySelectorAll('input[name="glissandoDuration"]').forEach(checkbox => {
        if (checkbox.checked) {
            checkbox.checked = false;
            toggleGlissandosByDuration(parseFloat(checkbox.value), false);
        }
    });

    updateGlissandoInfo();
}
</script>
