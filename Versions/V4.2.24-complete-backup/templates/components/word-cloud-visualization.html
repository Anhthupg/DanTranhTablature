<!-- Interactive Word Cloud Visualization -->
<!-- Frequency-sized, color-coded by semantic category -->

<div id="wordCloudSection" style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">

    <!-- Header -->
    <div style="margin-bottom: 20px; border-bottom: 2px solid #9B59B6; padding-bottom: 15px;">
        <h3 style="margin: 0; color: #2c3e50; font-size: 20px;">‚òÅÔ∏è Interactive Word Cloud - What Vietnamese Folk Songs Sing About</h3>
        <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">
            1,413 unique words across 121 songs. Word size = frequency, color = category. Click any word to see all songs using it.
        </p>
    </div>

    <!-- Controls -->
    <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
        <div>
            <label style="font-weight: 600; color: #555; margin-right: 10px;">Show Top:</label>
            <select id="wordCloudLimit" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                <option value="50">50 words</option>
                <option value="100" selected>100 words</option>
                <option value="150">150 words</option>
                <option value="200">200 words</option>
            </select>
        </div>

        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                <input type="checkbox" id="filter-nature" checked>
                <span style="color: #27ae60; font-weight: 600;">üåø Nature</span>
            </label>
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                <input type="checkbox" id="filter-family" checked>
                <span style="color: #e74c3c; font-weight: 600;">üë®‚Äçüë©‚Äçüëß Family</span>
            </label>
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                <input type="checkbox" id="filter-emotion" checked>
                <span style="color: #f39c12; font-weight: 600;">üíó Emotion</span>
            </label>
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                <input type="checkbox" id="filter-work" checked>
                <span style="color: #3498db; font-weight: 600;">‚öíÔ∏è Work</span>
            </label>
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                <input type="checkbox" id="filter-time" checked>
                <span style="color: #9b59b6; font-weight: 600;">‚è∞ Time</span>
            </label>
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                <input type="checkbox" id="filter-place" checked>
                <span style="color: #1abc9c; font-weight: 600;">üìç Place</span>
            </label>
            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                <input type="checkbox" id="filter-other" checked>
                <span style="color: #95a5a6; font-weight: 600;">üí¨ Other</span>
            </label>
        </div>
    </div>

    <!-- Word Cloud Canvas -->
    <div id="wordCloud" style="min-height: 500px; background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); border-radius: 8px; padding: 30px; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px; line-height: 1.4; position: relative; overflow: hidden;">
        <!-- Words will be dynamically generated here -->
        <div style="text-align: center; color: #999; width: 100%;">
            Loading word cloud...
        </div>
    </div>

    <!-- Selected Word Info Panel -->
    <div id="wordInfoPanel" style="display: none; margin-top: 20px; background: #f8f9fa; border-radius: 8px; padding: 20px; border-left: 4px solid #9B59B6;">
        <!-- Populated when word is clicked -->
    </div>

</div>

<style>
.cloud-word {
    display: inline-block;
    padding: 5px 10px;
    margin: 3px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    user-select: none;
    position: relative;
}

.cloud-word:hover {
    transform: scale(1.15);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 10;
}

.cloud-word.selected {
    box-shadow: 0 0 0 3px rgba(155, 89, 182, 0.5);
    transform: scale(1.2);
}

/* Tooltip */
.cloud-word-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 1000;
    margin-bottom: 5px;
}

.cloud-word:hover .cloud-word-tooltip {
    opacity: 1;
}

.cloud-word-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: rgba(0, 0, 0, 0.9);
}
</style>

<script>
// Word Cloud Visualization Component
(function() {
    let vocabularyData = null;
    let selectedWord = null;

    // Semantic category colors
    const categoryColors = {
        nature: { bg: '#27ae60', text: 'white' },
        family: { bg: '#e74c3c', text: 'white' },
        emotion: { bg: '#f39c12', text: 'white' },
        work: { bg: '#3498db', text: 'white' },
        time: { bg: '#9b59b6', text: 'white' },
        place: { bg: '#1abc9c', text: 'white' },
        other: { bg: '#95a5a6', text: 'white' }
    };

    // Semantic patterns (same as analyzer)
    const semanticPatterns = {
        nature: /trƒÉng|s√¥ng|chi·ªÅu|hoa|c√≤|ƒë√≤|m√¢y|n√∫i|bi·ªÉn|c√¢y|l√°|r·ª´ng|ƒë·ªìng|r·∫´y|m∆∞a|gi√≥|sao|tr·ªùi|s∆∞∆°ng|m√π|n·∫Øng|b√£o|l≈©|h·∫°n/i,
        family: /ch·ªìng|v·ª£|m·∫π|cha|con|anh|em|b√†|√¥ng|c√¥|ch√∫|b√°c|ch√°u|b·ªë|me|ch·ªã|trai|g√°i|n√†ng|phu|th√™|nhi|t·ª≠|ph·ª•|m·∫´u/i,
        emotion: /th∆∞∆°ng|nh·ªõ|bu·ªìn|vui|kh·ªï|ƒëau|y√™u|gh√©t|s·ª£|s·∫ßu|h·∫≠n|oan|t√¨nh|c·∫£m|th∆∞∆°ng/i,
        work: /l√†m|gi√£|ƒë·∫≠p|ch√®o|k√©o|c√†y|b·ª´a|tr·ªìng|thu|d·ªát|may|n·∫•u|h√≤/i,
        time: /chi·ªÅu|s√°ng|tr∆∞a|t·ªëi|ƒë√™m|h√¥m|mai|ng√†y|th√°ng|nƒÉm|m√πa|l√∫c|khi|th·ªùi/i,
        place: /l√†ng|th√†nh|ph·ªë|ch·ª£|nh√†|l·∫ßu|c·∫ßu|ƒë√≤|thuy·ªÅn|b·∫øn|s√¥ng|n√∫i|n∆°i|ch·ªën|x·ª©|qu√™|h∆∞∆°ng|ƒë·∫•t|tr·ªùi|hang|h·ªë|b·ªù|c·ª≠a|ph·ªß|ƒë√¨nh|ch√πa|mi·∫øu|qu√°n/i
    };

    function categorizeWord(word) {
        for (const [category, pattern] of Object.entries(semanticPatterns)) {
            if (pattern.test(word)) {
                return category;
            }
        }
        return 'other';
    }

    async function loadAndRenderWordCloud() {
        try {
            const response = await fetch('/api/vocabulary-metrics');
            vocabularyData = await response.json();

            renderWordCloud();
            attachEventListeners();

            console.log('[WordCloud] Loaded and rendered:', vocabularyData.overview);
        } catch (error) {
            console.error('[WordCloud] Error:', error);
            document.getElementById('wordCloud').innerHTML = `
                <div style="text-align: center; color: #e74c3c; padding: 40px;">
                    Error loading vocabulary data
                </div>
            `;
        }
    }

    function renderWordCloud() {
        if (!vocabularyData || !vocabularyData.topWords || vocabularyData.topWords.length === 0) {
            console.log('[WordCloud] Data not ready yet');
            return;
        }

        const limit = parseInt(document.getElementById('wordCloudLimit')?.value || 100);
        const words = vocabularyData.topWords.slice(0, limit);

        // Calculate font sizes based on frequency
        const maxFreq = words[0].frequency;
        const minFreq = words[words.length - 1].frequency;

        const container = document.getElementById('wordCloud');
        container.innerHTML = '';

        words.forEach(wordData => {
            const category = categorizeWord(wordData.word);
            const colors = categoryColors[category];

            // Check if category filter is enabled
            const filterCheckbox = document.getElementById(`filter-${category}`);
            if (filterCheckbox && !filterCheckbox.checked) {
                return; // Skip this word
            }

            // Calculate font size (12px - 48px range)
            const normalizedFreq = (wordData.frequency - minFreq) / (maxFreq - minFreq);
            const fontSize = 12 + (normalizedFreq * 36); // 12-48px range

            // Create word element
            const wordEl = document.createElement('div');
            wordEl.className = 'cloud-word';
            wordEl.dataset.word = wordData.word;
            wordEl.dataset.category = category;
            wordEl.style.fontSize = `${fontSize}px`;
            wordEl.style.background = colors.bg;
            wordEl.style.color = colors.text;

            // Vietnamese word
            const vnSpan = document.createElement('span');
            vnSpan.textContent = wordData.word;
            wordEl.appendChild(vnSpan);

            // Tooltip with metrics
            const tooltip = document.createElement('div');
            tooltip.className = 'cloud-word-tooltip';
            tooltip.innerHTML = `
                <strong>${wordData.word}</strong> = ${wordData.english}<br>
                ${wordData.frequency}√ó (${wordData.percentage}%)<br>
                In ${wordData.appearsInSongs} songs (${wordData.songPercentage}%)<br>
                Category: ${category}
            `;
            wordEl.appendChild(tooltip);

            // Click handler
            wordEl.addEventListener('click', () => showWordInfo(wordData, category));

            container.appendChild(wordEl);
        });

        console.log(`[WordCloud] Rendered ${words.length} words`);
    }

    function showWordInfo(wordData, category) {
        // Highlight selected word
        document.querySelectorAll('.cloud-word').forEach(el => el.classList.remove('selected'));
        const clickedWord = Array.from(document.querySelectorAll('.cloud-word'))
            .find(el => el.dataset.word === wordData.word);
        if (clickedWord) clickedWord.classList.add('selected');

        selectedWord = wordData;

        const panel = document.getElementById('wordInfoPanel');
        const colors = categoryColors[category];

        panel.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div>
                    <h4 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 24px;">${wordData.word}</h4>
                    <div style="font-size: 16px; color: #666; font-style: italic;">${wordData.english}</div>
                </div>
                <div style="background: ${colors.bg}; color: ${colors.text}; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; text-transform: capitalize;">
                    ${category}
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div style="background: white; padding: 12px; border-radius: 6px; border: 2px solid #3498db;">
                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">Total Uses</div>
                    <div style="font-size: 24px; font-weight: bold; color: #3498db;">${wordData.frequency}</div>
                    <div style="font-size: 11px; color: #666;">${wordData.percentage}% of all words</div>
                </div>

                <div style="background: white; padding: 12px; border-radius: 6px; border: 2px solid #27ae60;">
                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">Appears In</div>
                    <div style="font-size: 24px; font-weight: bold; color: #27ae60;">${wordData.appearsInSongs} songs</div>
                    <div style="font-size: 11px; color: #666;">${wordData.songPercentage}% of collection</div>
                </div>

                <div style="background: white; padding: 12px; border-radius: 6px; border: 2px solid #9b59b6;">
                    <div style="font-size: 12px; color: #999; margin-bottom: 3px;">Avg per Song</div>
                    <div style="font-size: 24px; font-weight: bold; color: #9b59b6;">${(wordData.frequency / wordData.appearsInSongs).toFixed(1)}</div>
                    <div style="font-size: 11px; color: #666;">times when used</div>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <div style="font-weight: 600; color: #555; margin-bottom: 8px; font-size: 14px;">Songs Using "${wordData.word}":</div>
                <div id="wordSongsList" style="max-height: 200px; overflow-y: auto; background: white; padding: 12px; border-radius: 6px; border: 1px solid #e0e0e0;">
                    Loading songs...
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="window.loadSongFromWord('${wordData.word}')" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600;">
                    üìñ View First Song
                </button>
                <button onclick="window.closeWordInfo()" style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600;">
                    Close
                </button>
            </div>
        `;

        panel.style.display = 'block';

        // Load songs containing this word
        loadSongsForWord(wordData.word);
    }

    async function loadSongsForWord(word) {
        try {
            // Scan all lyrics files to find which songs contain this word
            const response = await fetch('/api/library');
            const library = await response.json();

            const songsWithWord = [];

            // Check each song
            for (const song of library.songs) {
                try {
                    const lyricsResponse = await fetch(`/api/lyrics/${encodeURIComponent(song.filename.replace('.musicxml.xml', ''))}`);
                    const lyricsData = await lyricsResponse.json();

                    let count = 0;
                    lyricsData.phrases.forEach(phrase => {
                        if (phrase.wordMapping) {
                            phrase.wordMapping.forEach(mapping => {
                                if (mapping.vn.toLowerCase() === word.toLowerCase()) {
                                    count++;
                                }
                            });
                        }
                    });

                    if (count > 0) {
                        songsWithWord.push({
                            title: song.title || song.filename.replace('.musicxml.xml', ''),
                            filename: song.filename,
                            count
                        });
                    }
                } catch (err) {
                    // Song might not have lyrics, skip
                }
            }

            // Sort by usage count
            songsWithWord.sort((a, b) => b.count - a.count);

            // Render song list
            const listEl = document.getElementById('wordSongsList');
            if (songsWithWord.length === 0) {
                listEl.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">No songs found with this word</div>';
                return;
            }

            listEl.innerHTML = songsWithWord.map((song, i) => `
                <div style="padding: 8px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s;"
                     onmouseover="this.style.background='#f8f9fa'"
                     onmouseout="this.style.background='white'"
                     onclick="window.libraryController?.selectSong('${song.filename}')">
                    <div>
                        <span style="color: #9b59b6; font-weight: 600; margin-right: 10px;">${i + 1}.</span>
                        <span style="color: #2c3e50; font-weight: 600;">${song.title}</span>
                    </div>
                    <span style="background: #9b59b6; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                        ${song.count}√ó
                    </span>
                </div>
            `).join('');

        } catch (error) {
            console.error('[WordCloud] Error loading songs:', error);
        }
    }

    function attachEventListeners() {
        // Limit selector
        const limitSelect = document.getElementById('wordCloudLimit');
        if (limitSelect) {
            limitSelect.addEventListener('change', renderWordCloud);
        }

        // Category filters
        ['nature', 'family', 'emotion', 'work', 'time', 'place', 'other'].forEach(cat => {
            const checkbox = document.getElementById(`filter-${cat}`);
            if (checkbox) {
                checkbox.addEventListener('change', renderWordCloud);
            }
        });
    }

    window.closeWordInfo = function() {
        document.getElementById('wordInfoPanel').style.display = 'none';
        document.querySelectorAll('.cloud-word').forEach(el => el.classList.remove('selected'));
        selectedWord = null;
    };

    window.loadSongFromWord = function(word) {
        // Find first song with this word and load it
        const listEl = document.getElementById('wordSongsList');
        const firstSong = listEl.querySelector('[onclick]');
        if (firstSong) {
            firstSong.click();
        }
    };

    // Initialize when DOM ready
    document.addEventListener('DOMContentLoaded', () => {
        loadAndRenderWordCloud();
        console.log('[WordCloud] Component initialized');
    });

    // Expose refresh for library updates
    window.refreshWordCloud = loadAndRenderWordCloud;

})();
</script>
