<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V4 Library - 128 Vietnamese Traditional Songs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* Header */
        .library-header {
            background: linear-gradient(135deg, #008080 0%, #00a8a8 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .library-header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .library-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Controls */
        .library-controls {
            background: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2c3e50;
        }

        select, input {
            padding: 0.6rem 1rem;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 0.95rem;
            background: white;
            transition: all 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #008080;
        }

        .stats-summary {
            margin-left: auto;
            text-align: right;
        }

        .stats-summary .stat {
            font-size: 0.9rem;
            color: #5a6c7d;
        }

        .stats-summary .stat strong {
            color: #008080;
            font-size: 1.3rem;
        }

        /* Song Grid */
        .songs-grid {
            padding: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .song-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }

        .song-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .song-header {
            padding: 1.2rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 3px solid #008080;
        }

        .song-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .song-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-region { background: #e3f2fd; color: #1976d2; }
        .badge-genre { background: #e8f5e9; color: #388e3c; }
        .badge-tuning { background: #f3e5f5; color: #7b1fa2; }

        .song-metrics {
            padding: 1rem 1.2rem;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            background: #fafbfc;
        }

        .metric {
            text-align: center;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #008080;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.2rem;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="library-header">
        <h1>Đàn Tranh Tablature Library</h1>
        <p>Vietnamese Traditional Music Collection - V4.0.2</p>
    </div>

    <div class="library-controls">
        <div class="control-group">
            <label for="sortBy">Sort By</label>
            <select id="sortBy">
                <option value="title">Title (A-Z)</option>
                <option value="totalNotes">Total Notes</option>
                <option value="bentNotes">Bent Notes</option>
                <option value="region">Region</option>
                <option value="genre">Genre</option>
                <option value="tuning">Tuning System</option>
            </select>
        </div>

        <div class="control-group">
            <label for="filterRegion">Region</label>
            <select id="filterRegion">
                <option value="all">All Regions</option>
                <option value="Northern">Northern</option>
                <option value="Southern">Southern</option>
                <option value="Central">Central</option>
                <option value="Highland">Highland</option>
                <option value="Unknown">Unknown</option>
            </select>
        </div>

        <div class="control-group">
            <label for="filterGenre">Genre</label>
            <select id="filterGenre">
                <option value="all">All Genres</option>
                <option value="Traditional">Traditional</option>
                <option value="Hò">Hò (Work Songs)</option>
                <option value="Ru Con">Ru Con (Lullabies)</option>
                <option value="Lý">Lý (Lyrical Songs)</option>
                <option value="Hát Chèo">Hát Chèo (Opera)</option>
                <option value="Quan Họ">Quan Họ (Folk Duets)</option>
            </select>
        </div>

        <div class="control-group">
            <label for="searchTitle">Search</label>
            <input type="text" id="searchTitle" placeholder="Search by title...">
        </div>

        <div class="stats-summary">
            <div class="stat">
                <strong id="displayCount">0</strong> songs displayed
            </div>
            <div class="stat">
                <span id="totalSongs">0</span> total in library
            </div>
        </div>
    </div>

    <div class="songs-grid" id="songsGrid">
        <div class="loading">Loading library</div>
    </div>

    <script src="/static/client-tablature-generator.js"></script>
    <script>
        let allSongs = [];
        let filteredSongs = [];

        // Load library on page load
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/library');
                allSongs = await response.json();
                filteredSongs = [...allSongs];

                console.log(`Loaded ${allSongs.length} songs from library`);

                updateDisplay();
                attachEventListeners();
            } catch (error) {
                console.error('Failed to load library:', error);
                document.getElementById('songsGrid').innerHTML = `
                    <div class="empty-state">
                        <h3>Failed to load library</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });

        // Attach event listeners
        function attachEventListeners() {
            document.getElementById('sortBy').addEventListener('change', updateDisplay);
            document.getElementById('filterRegion').addEventListener('change', applyFilters);
            document.getElementById('filterGenre').addEventListener('change', applyFilters);
            document.getElementById('searchTitle').addEventListener('input', applyFilters);
        }

        // Apply filters
        function applyFilters() {
            const region = document.getElementById('filterRegion').value;
            const genre = document.getElementById('filterGenre').value;
            const search = document.getElementById('searchTitle').value.toLowerCase();

            filteredSongs = allSongs.filter(song => {
                const matchRegion = region === 'all' || song.region === region;
                const matchGenre = genre === 'all' || song.genre === genre;
                const matchSearch = search === '' || song.title.toLowerCase().includes(search);
                return matchRegion && matchGenre && matchSearch;
            });

            updateDisplay();
        }

        // Update display
        function updateDisplay() {
            const sortBy = document.getElementById('sortBy').value;

            // Sort
            filteredSongs.sort((a, b) => {
                if (sortBy === 'title') {
                    return a.title.localeCompare(b.title);
                } else if (sortBy === 'totalNotes' || sortBy === 'bentNotes') {
                    return b[sortBy] - a[sortBy];
                } else {
                    return a[sortBy]?.localeCompare(b[sortBy] || '') || 0;
                }
            });

            // Render
            const grid = document.getElementById('songsGrid');

            if (filteredSongs.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>No songs found</h3>
                        <p>Try adjusting your filters or search term</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredSongs.map(song => `
                <div class="song-card" onclick="openSong('${song.filename}')">
                    <div class="song-header">
                        <div class="song-title">${song.title}</div>
                        <div class="song-badges">
                            <span class="badge badge-region">${song.region}</span>
                            <span class="badge badge-genre">${song.genre}</span>
                            <span class="badge badge-tuning">${song.optimalTuning}</span>
                        </div>
                    </div>
                    <div class="song-metrics">
                        <div class="metric">
                            <div class="metric-value">${song.totalNotes}</div>
                            <div class="metric-label">Total Notes</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${song.uniquePitches}</div>
                            <div class="metric-label">Pitches</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${song.bentNotes}</div>
                            <div class="metric-label">Bent Notes</div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Update stats
            document.getElementById('displayCount').textContent = filteredSongs.length;
            document.getElementById('totalSongs').textContent = allSongs.length;
        }

        // Open individual song viewer
        function openSong(filename) {
            console.log('Opening song:', filename);
            // TODO: Navigate to individual song viewer
            alert(`Opening: ${filename}\n\nIndividual song viewers coming soon!`);
        }
    </script>
</body>
</html>