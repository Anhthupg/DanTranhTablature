<!-- Word Journey Map - Sankey Diagram Component -->
<div class="analysis-section" id="wordJourneySection" data-order="17" data-focus="word-journey">

    <!-- VERTICAL HEADER (Uniform Style) -->
    <div class="vertical-header" onclick="toggleSection('wordJourneySection')">
        <h3 class="section-title">Word Journey Map</h3>
        <div class="vertical-controls">
            <button class="vertical-move-arrow" onclick="moveSection('wordJourneySection', 'up'); event.stopPropagation();">▲</button>
            <button class="vertical-move-arrow" onclick="moveSection('wordJourneySection', 'down'); event.stopPropagation();">▼</button>
        </div>
    </div>

    <div class="section-content">
        <!-- Controls -->
        <div class="sankey-controls">
            <label>
                Show top:
                <select id="sankeyTopN" onchange="updateSankeyDiagram()">
                    <option value="10">10 words</option>
                    <option value="20">20 words</option>
                    <option value="30">30 words</option>
                    <option value="50" selected>50 words</option>
                    <option value="100">100 words</option>
                    <option value="200">200 words</option>
                </select>
            </label>

            <label>
                <input type="checkbox" id="sankeyShowLabels" checked onchange="updateSankeyDiagram()">
                Show labels
            </label>

            <label>
                Category filter:
                <select id="sankeyCategoryFilter" onchange="updateSankeyDiagram()">
                    <option value="all">All categories</option>
                    <option value="emotion">Emotion</option>
                    <option value="nature">Nature</option>
                    <option value="family">Family</option>
                    <option value="social">Social</option>
                    <option value="work">Work</option>
                    <option value="time">Time</option>
                    <option value="place">Place</option>
                    <option value="expression">Expression</option>
                    <option value="other">Other</option>
                </select>
            </label>
        </div>

        <!-- Sankey Diagram with Data Card -->
        <div style="display: flex; gap: 20px; align-items: flex-start;">
            <div id="sankeyDiagram" style="flex: 1; min-height: 600px; max-height: 3000px; overflow: auto;">
                <!-- Sankey will render here with dynamic height -->
            </div>

            <!-- Dynamic Data Card -->
            <div id="sankeyDataCard" style="width: 300px; min-height: 600px; position: sticky; top: 20px; display: none;">
                <div style="background: white; border: 2px solid #008080; border-radius: 8px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <h4 style="margin: 0 0 15px 0; color: #008080; border-bottom: 2px solid #008080; padding-bottom: 10px;">Word Journey</h4>

                    <div class="journey-detail">
                        <div class="detail-section">
                            <label>Vietnamese:</label>
                            <div id="cardVietnamese" style="font-size: 20px; font-weight: 700; color: #008080; margin: 5px 0 15px 0;">-</div>
                        </div>

                        <div class="detail-section">
                            <label>English:</label>
                            <div id="cardEnglish" style="font-size: 16px; color: #3498DB; margin: 5px 0 15px 0;">-</div>
                        </div>

                        <div class="detail-section">
                            <label>Category:</label>
                            <div id="cardCategory" style="display: inline-block; margin: 5px 0 15px 0;">-</div>
                        </div>

                        <div class="detail-section">
                            <label>Frequency:</label>
                            <div id="cardFrequency" style="font-size: 18px; font-weight: 600; color: #E74C3C; margin: 5px 0 15px 0;">-</div>
                        </div>

                        <div class="detail-section">
                            <label>Song Count:</label>
                            <div id="cardSongCount" style="font-size: 18px; font-weight: 600; color: #27AE60; margin: 5px 0 15px 0;">-</div>
                        </div>

                        <div class="detail-section">
                            <label>Journey Flow:</label>
                            <div id="cardFlow" style="font-size: 13px; line-height: 1.6; padding: 10px; background: rgba(0,128,128,0.05); border-radius: 4px; margin-top: 5px;">
                                Vietnamese word → English meaning → Semantic category → Appears in songs
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Statistics -->
        <div class="category-stats">
            <h4>Category Statistics</h4>
            <div id="categoryStatsTable"></div>
        </div>

        <!-- Example Journey -->
        <div class="example-journey">
            <h4>Example Journey</h4>
            <div class="journey-path">
                <strong>thuong</strong> → love/feelings → <span class="category-badge emotion">emotion</span> → 30 songs
            </div>
            <p class="journey-insight">
                Shows how the word "thuong" (love/feelings) flows through 30 songs in the emotional category.
                Flow thickness indicates frequency: thicker = more common.
            </p>
        </div>
    </div>
</div>

<style>
/* Word Journey Section Styles */
.sankey-controls {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(0, 128, 128, 0.05);
    border-radius: 8px;
    flex-wrap: wrap;
}

.sankey-controls label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.sankey-controls select {
    padding: 5px 10px;
    border: 1px solid #008080;
    border-radius: 4px;
    background: white;
    cursor: pointer;
}

#sankeyDiagram {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 20px;
    position: relative;
}

/* Sankey SVG Styles */
.sankey-link {
    fill: none;
    stroke-opacity: 0.3;
    transition: all 0.3s ease;
    cursor: pointer;
}

.sankey-link:hover,
.sankey-link.highlighted {
    stroke-opacity: 0.9;
    filter: drop-shadow(0 0 8px currentColor);
}

.sankey-node rect {
    stroke: #333;
    stroke-width: 1px;
    transition: fill-opacity 0.3s;
}

.sankey-node:hover rect {
    fill-opacity: 0.8;
}

.sankey-node text {
    font-size: 12px;
    fill: #333;
    text-shadow: 0 1px 0 #fff;
}

/* Category badges */
.category-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    color: white;
}

.category-badge.emotion { background: #E74C3C; }
.category-badge.nature { background: #27AE60; }
.category-badge.family { background: #9B59B6; }
.category-badge.social { background: #3498DB; }
.category-badge.work { background: #E67E22; }
.category-badge.time { background: #F39C12; }
.category-badge.place { background: #1ABC9C; }
.category-badge.expression { background: #FFD700; color: #333; }
.category-badge.other { background: #95A5A6; }

/* Category stats table */
.category-stats {
    margin: 20px 0;
    padding: 15px;
    background: rgba(0, 128, 128, 0.05);
    border-radius: 8px;
}

.category-stats h4 {
    margin-top: 0;
    color: #008080;
}

#categoryStatsTable {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.category-stat-card {
    padding: 12px;
    background: white;
    border-radius: 6px;
    border-left: 4px solid;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.category-stat-card h5 {
    margin: 0 0 8px 0;
    font-size: 14px;
}

.category-stat-card .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #008080;
}

.category-stat-card .stat-label {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
}

/* Example journey */
.example-journey {
    padding: 15px;
    background: rgba(52, 152, 219, 0.1);
    border-left: 4px solid #3498DB;
    border-radius: 4px;
}

.example-journey h4 {
    margin-top: 0;
    color: #3498DB;
}

.journey-path {
    font-size: 18px;
    margin: 12px 0;
    padding: 10px;
    background: white;
    border-radius: 4px;
}

.journey-insight {
    margin: 8px 0 0 0;
    font-size: 14px;
    color: #555;
    line-height: 1.6;
}

/* Data card styles */
.detail-section {
    margin-bottom: 12px;
}

.detail-section label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 3px;
}
</style>

<script>
// Word Journey Sankey Controller
class WordJourneySankeyController {
    constructor() {
        this.data = null;
        this.svg = null;
        this.margin = { top: 20, right: 200, bottom: 20, left: 200 };
    }

    async initialize() {
        try {
            console.log('[Sankey] Initializing Word Journey Sankey...');

            // Load data
            console.log('[Sankey] Fetching data from /api/word-journey-sankey...');
            const response = await fetch('/api/word-journey-sankey');

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            this.data = await response.json();
            console.log('[Sankey] Data loaded:', {
                journeys: this.data.journeys?.length || 0,
                categories: this.data.categoryStats?.length || 0,
                totalWords: this.data.metadata?.totalWords || 0
            });

            // Render initial diagram
            console.log('[Sankey] Rendering diagram...');
            this.renderDiagram();
            console.log('[Sankey] Diagram rendered successfully');

            console.log('[Sankey] Rendering category stats...');
            this.renderCategoryStats();
            console.log('[Sankey] Category stats rendered successfully');

            console.log('[Sankey] Initialization complete!');
        } catch (error) {
            console.error('[Sankey] INITIALIZATION FAILED:', error);
            console.error('[Sankey] Error stack:', error.stack);

            // Show error in UI
            const container = document.getElementById('sankeyDiagram');
            if (container) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #E74C3C;">
                        <h3 style="margin: 0 0 10px 0;">Failed to Load Sankey Diagram</h3>
                        <p style="margin: 0; font-size: 14px; color: #666;">
                            ${error.message}
                        </p>
                        <p style="margin: 10px 0 0 0; font-size: 12px; color: #999;">
                            Check browser console for details
                        </p>
                    </div>
                `;
            }
        }
    }

    renderDiagram() {
        try {
            console.log('[Sankey] renderDiagram() called');

            const topN = parseInt(document.getElementById('sankeyTopN').value);
            const showLabels = document.getElementById('sankeyShowLabels').checked;
            const categoryFilter = document.getElementById('sankeyCategoryFilter').value;

            console.log('[Sankey] Parameters:', { topN, showLabels, categoryFilter });

            // Clear existing
            document.getElementById('sankeyDiagram').innerHTML = '';

            // Filter data
            let filteredJourneys = this.data.journeys.slice(0, topN);
            if (categoryFilter !== 'all') {
                filteredJourneys = filteredJourneys.filter(j => j.category === categoryFilter);
            }

            console.log('[Sankey] Filtered journeys:', filteredJourneys.length);

            // Build simplified Sankey nodes and links
            console.log('[Sankey] Building nodes...');
            const nodes = this.buildNodes(filteredJourneys);
            console.log('[Sankey] Nodes built:', nodes.size);

            console.log('[Sankey] Building links...');
            const links = this.buildLinks(filteredJourneys, nodes);
            console.log('[Sankey] Links built:', links.length);

            // Render SVG
            console.log('[Sankey] Rendering SVG...');
            this.renderSVG(nodes, links, showLabels);
            console.log('[Sankey] SVG rendered');
        } catch (error) {
            console.error('[Sankey] renderDiagram() FAILED:', error);
            console.error('[Sankey] Error stack:', error.stack);
            throw error;
        }
    }

    buildNodes(journeys) {
        const nodes = new Map();
        let nodeId = 0;

        journeys.forEach(j => {
            // Vietnamese word node
            const wordKey = `word_${j.vietnamese}`;
            if (!nodes.has(wordKey)) {
                nodes.set(wordKey, { id: nodeId++, name: j.vietnamese, layer: 0, type: 'word' });
            }

            // English meaning node
            const meaningKey = `meaning_${j.english}`;
            if (!nodes.has(meaningKey)) {
                nodes.set(meaningKey, { id: nodeId++, name: j.english, layer: 1, type: 'meaning' });
            }

            // Category node
            const catKey = `category_${j.category}`;
            if (!nodes.has(catKey)) {
                nodes.set(catKey, { id: nodeId++, name: j.category, layer: 2, type: 'category' });
            }

            // Songs node
            const songsKey = `songs_${j.vietnamese}`;
            if (!nodes.has(songsKey)) {
                nodes.set(songsKey, { id: nodeId++, name: `${j.songCount} songs`, layer: 3, type: 'songs' });
            }
        });

        return nodes;
    }

    buildLinks(journeys, nodes) {
        const links = [];

        journeys.forEach(j => {
            const wordNode = nodes.get(`word_${j.vietnamese}`);
            const meaningNode = nodes.get(`meaning_${j.english}`);
            const catNode = nodes.get(`category_${j.category}`);
            const songsNode = nodes.get(`songs_${j.vietnamese}`);

            // Create unique journey ID for this word
            const journeyId = `journey_${j.vietnamese}`;

            // Word → Meaning
            links.push({
                source: wordNode.id,
                target: meaningNode.id,
                value: j.frequency,
                category: j.category,
                journeyId: journeyId,
                journeyData: j  // Store full journey data
            });

            // Meaning → Category
            links.push({
                source: meaningNode.id,
                target: catNode.id,
                value: j.frequency,
                category: j.category,
                journeyId: journeyId,
                journeyData: j
            });

            // Category → Songs
            links.push({
                source: catNode.id,
                target: songsNode.id,
                value: j.songCount,
                category: j.category,
                journeyId: journeyId,
                journeyData: j
            });
        });

        return links;
    }

    renderSVG(nodes, links, showLabels) {
        try {
            console.log('[Sankey] renderSVG() called with:', {
                nodes: nodes.size,
                links: links.length,
                showLabels
            });

            const container = document.getElementById('sankeyDiagram');
            if (!container) {
                throw new Error('Container #sankeyDiagram not found');
            }

            const width = container.clientWidth;

            // Calculate height dynamically based on number of nodes
            const nodeArray = Array.from(nodes.values());
            const layers = [[], [], [], []];
            nodeArray.forEach(node => {
                layers[node.layer].push(node);
            });

            const nodeHeight = 15;
            const nodeGap = 5;
            const maxNodesInLayer = Math.max(...layers.map(l => l.length));
            const calculatedHeight = this.margin.top + this.margin.bottom +
                                    (maxNodesInLayer * (nodeHeight + nodeGap));
            const height = Math.max(600, calculatedHeight); // Minimum 600px

            console.log('[Sankey] Container dimensions:', {
                width,
                height,
                maxNodesInLayer,
                calculatedHeight
            });

            if (width <= 0) {
                throw new Error(`Invalid container width: ${width}px`);
            }

            // Create SVG
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.style.background = '#f9f9f9';
            console.log('[Sankey] SVG element created');

        // Simple vertical layout (columns)
        const layerWidth = (width - this.margin.left - this.margin.right) / 4;

        layers.forEach((layer, layerIndex) => {
            const layerX = this.margin.left + layerIndex * layerWidth;
            layer.forEach((node, nodeIndex) => {
                node.x = layerX;
                node.y = this.margin.top + nodeIndex * (nodeHeight + nodeGap);
                node.width = layerWidth * 0.15;
                node.height = nodeHeight;
            });
        });

        // Draw links
        const linkGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        linkGroup.setAttribute('class', 'sankey-links');

        links.forEach(link => {
            const sourceNode = nodeArray.find(n => n.id === link.source);
            const targetNode = nodeArray.find(n => n.id === link.target);

            if (!sourceNode || !targetNode) return;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');

            const sx = sourceNode.x + sourceNode.width;
            const sy = sourceNode.y + sourceNode.height / 2;
            const tx = targetNode.x;
            const ty = targetNode.y + targetNode.height / 2;

            const cx = (sx + tx) / 2;

            const d = `M ${sx} ${sy} C ${cx} ${sy}, ${cx} ${ty}, ${tx} ${ty}`;
            path.setAttribute('d', d);
            path.setAttribute('class', 'sankey-link');
            path.setAttribute('stroke', this.getCategoryColor(link.category));
            path.setAttribute('stroke-width', Math.max(2, Math.min(link.value / 10, 15)));

            // Add journey ID for grouped highlighting
            path.setAttribute('data-journey-id', link.journeyId);

            // Store journey data for data card
            path.journeyData = link.journeyData;

            // Add hover event listeners
            path.addEventListener('mouseenter', () => this.highlightJourney(link.journeyId, link.journeyData));
            path.addEventListener('mouseleave', () => this.clearHighlight());

            linkGroup.appendChild(path);
        });

        svg.appendChild(linkGroup);

        // Draw nodes
        const nodeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        nodeGroup.setAttribute('class', 'sankey-nodes');

        nodeArray.forEach(node => {
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('class', 'sankey-node');

            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', node.x);
            rect.setAttribute('y', node.y);
            rect.setAttribute('width', node.width);
            rect.setAttribute('height', node.height);
            rect.setAttribute('fill', this.getNodeColor(node.type));
            rect.setAttribute('rx', 3);

            g.appendChild(rect);

            if (showLabels) {
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', node.x + node.width + 5);
                text.setAttribute('y', node.y + node.height / 2);
                text.setAttribute('dy', '0.35em');
                text.setAttribute('font-size', '11px');
                text.setAttribute('fill', '#333');
                text.textContent = node.name;

                g.appendChild(text);
            }

            nodeGroup.appendChild(g);
        });

        svg.appendChild(nodeGroup);
            console.log('[Sankey] Node group appended to SVG');

            container.appendChild(svg);
            console.log('[Sankey] SVG appended to container - rendering complete!');
        } catch (error) {
            console.error('[Sankey] renderSVG() FAILED:', error);
            console.error('[Sankey] Error stack:', error.stack);
            throw error;
        }
    }

    highlightJourney(journeyId, journeyData) {
        // Highlight all segments with this journey ID
        const allPaths = document.querySelectorAll(`[data-journey-id="${journeyId}"]`);
        allPaths.forEach(path => path.classList.add('highlighted'));

        // Show and populate data card
        const dataCard = document.getElementById('sankeyDataCard');
        if (dataCard) {
            dataCard.style.display = 'block';

            // Populate card fields
            document.getElementById('cardVietnamese').textContent = journeyData.vietnamese;
            document.getElementById('cardEnglish').textContent = journeyData.english;

            // Category badge with color
            const categoryEl = document.getElementById('cardCategory');
            const categoryColor = this.getCategoryColor(journeyData.category);
            categoryEl.innerHTML = `<span class="category-badge" style="background: ${categoryColor};">${journeyData.category}</span>`;

            document.getElementById('cardFrequency').textContent = `${journeyData.frequency} occurrences`;
            document.getElementById('cardSongCount').textContent = `${journeyData.songCount} songs`;

            // Update flow description
            const flowText = `"${journeyData.vietnamese}" (Vietnamese word) → "${journeyData.english}" (English meaning) → ${journeyData.category} (semantic category) → appears in ${journeyData.songCount} songs`;
            document.getElementById('cardFlow').textContent = flowText;
        }
    }

    clearHighlight() {
        // Remove all highlights
        const allHighlighted = document.querySelectorAll('.sankey-link.highlighted');
        allHighlighted.forEach(path => path.classList.remove('highlighted'));

        // Hide data card
        const dataCard = document.getElementById('sankeyDataCard');
        if (dataCard) {
            dataCard.style.display = 'none';
        }
    }

    getCategoryColor(category) {
        const colors = {
            emotion: '#E74C3C',
            nature: '#27AE60',
            family: '#9B59B6',
            social: '#3498DB',
            work: '#E67E22',
            time: '#F39C12',
            place: '#1ABC9C',
            expression: '#FFD700',
            other: '#95A5A6'
        };
        return colors[category] || colors.other;
    }

    getNodeColor(type) {
        const colors = {
            word: '#008080',      // Teal
            meaning: '#3498DB',   // Blue
            category: '#9B59B6',  // Purple
            songs: '#E74C3C'      // Red
        };
        return colors[type] || '#95A5A6';
    }

    renderCategoryStats() {
        const container = document.getElementById('categoryStatsTable');
        container.innerHTML = '';

        this.data.categoryStats.slice(0, 8).forEach(cat => {
            const card = document.createElement('div');
            card.className = 'category-stat-card';
            card.style.borderLeftColor = this.getCategoryColor(cat.category);

            card.innerHTML = `
                <h5>${cat.category.toUpperCase()}</h5>
                <div class="stat-value">${cat.totalFrequency}</div>
                <div class="stat-label">${cat.wordCount} unique words</div>
                <div class="stat-label">${cat.totalSongs} song appearances</div>
            `;

            container.appendChild(card);
        });
    }
}

// Initialize on load
let wordJourneySankeyController;

// Initialize immediately or on load
(function() {
    function init() {
        if (!wordJourneySankeyController) {
            wordJourneySankeyController = new WordJourneySankeyController();
            wordJourneySankeyController.initialize();
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();

// Update function for controls
function updateSankeyDiagram() {
    if (wordJourneySankeyController) {
        wordJourneySankeyController.renderDiagram();
    }
}
</script>
