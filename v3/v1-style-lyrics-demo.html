<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V1-Style Lyrics Demo - Vietnamese Learning</title>
    <style>
        /* DanTranhTuningAnalyzer v3.5.8 Framework Styles */

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        header h2 {
            color: #7f8c8d;
            font-weight: normal;
            font-size: 1.1em;
        }

        /* Theme System - 4 themes compliance */
        body.theme-white {
            background: #FFFFFF;
            --panel-bg: #FFFFFF;
            --panel-border: #E0E0E0;
            --text-primary: #2C3E50;
            --text-secondary: #7F8C8D;
        }

        body.theme-light-grey {
            background: #D0D0D0;
            --panel-bg: rgba(255, 255, 255, 0.95);
            --panel-border: #B0B0B0;
            --text-primary: #2C3E50;
            --text-secondary: #5A5A5A;
        }

        body.theme-dark-grey {
            background: #2C3E50;
            --panel-bg: rgba(52, 73, 94, 0.9);
            --panel-border: #34495E;
            --text-primary: #ECF0F1;
            --text-secondary: #BDC3C7;
        }

        body.theme-black {
            background: #000000;
            --panel-bg: rgba(26, 26, 26, 0.9);
            --panel-border: #333333;
            --text-primary: #FFFFFF;
            --text-secondary: #CCCCCC;
        }

        /* Theme Selector */
        .theme-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--panel-bg, white);
            border: 1px solid var(--panel-border, #ddd);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .theme-selector select {
            background: transparent;
            border: none;
            color: var(--text-primary, #2c3e50);
            font-size: 12px;
            cursor: pointer;
        }

        /* Dual-Panel Collapsible System */
        .tuning-analyzer-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .tuning-panel {
            background: var(--panel-bg, white);
            border: 2px solid var(--panel-border, #e0e0e0);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Lyrics Panel System */
        .lyrics-panel {
            background: var(--panel-bg, white);
            border: 2px solid var(--panel-border, #e0e0e0);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .lyrics-buttons-container {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--panel-border, #e0e0e0);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .lyrics-button {
            background: #27ae60; /* 12-color system green */
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .lyrics-button:hover {
            background: #219a52;
            transform: translateY(-1px);
        }

        .lyrics-button.active {
            background: #3498db; /* Blue when active */
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .lyrics-content {
            padding: 20px;
            min-height: 60px;
            background: var(--panel-bg, white);
            color: var(--text-primary, #2c3e50);
            line-height: 1.6;
            font-size: 16px;
            border-top: 1px solid var(--panel-border, #e0e0e0);
            display: none;
        }

        .lyrics-content.visible {
            display: block;
        }

        .lyrics-content h4 {
            margin: 0 0 10px 0;
            color: #3498db; /* 12-color system blue */
            font-size: 18px;
        }

        .lyrics-content .verse {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(52, 152, 219, 0.05);
            border-left: 3px solid #3498db;
            border-radius: 4px;
        }

        /* V1-Style Lyrics Layout */
        .v1-lyrics-container {
            background: rgba(52, 152, 219, 0.02);
            border: 1px solid rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .lyrics-headers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498DB;
        }

        .vietnamese-header, .english-header {
            font-weight: bold;
            font-size: 16px;
            color: #2C3E50;
            text-align: center;
        }

        .lyrics-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            background: none;
            border: 1px solid #3498DB;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        .control-btn:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .lyrics-note {
            font-size: 12px;
            color: #7F8C8D;
            margin-left: 10px;
        }

        .lyrics-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .vietnamese-lyrics, .english-lyrics {
            font-size: 18px;
            line-height: 1.8;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 6px;
        }

        .vietnamese-lyrics {
            color: #2C3E50;
            font-weight: 500;
        }

        .english-lyrics {
            color: #7F8C8D;
            font-style: italic;
        }

        .pipe-separator {
            color: #3498DB;
            cursor: pointer;
            margin: 0 2px;
            transition: background 0.2s ease;
            padding: 0 1px;
            border-radius: 2px;
        }

        .pipe-separator:hover {
            background: rgba(52, 152, 219, 0.2);
        }

        .lyrics-bottom-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 12px;
            color: #7F8C8D;
        }

        .font-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .font-controls label {
            font-size: 12px;
        }

        .font-controls select {
            padding: 2px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }

        .font-controls button {
            padding: 4px 8px;
            font-size: 12px;
        }

        .phrase-line {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .phrase-line:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .vietnamese-phrase {
            font-size: 18px;
            font-weight: 500;
            line-height: 1.4;
            color: var(--text-primary, #2c3e50);
        }

        .english-phrase {
            font-size: 16px;
            font-style: italic;
            line-height: 1.4;
            color: var(--text-secondary, #7f8c8d);
        }

        /* Word-by-word highlighting system */
        .word-segment {
            display: inline;
            padding: 2px 4px;
            margin: 0 1px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .word-segment:hover {
            background: rgba(255, 215, 0, 0.3);
        }

        .word-segment.highlighted {
            background: #FFD700; /* Gold from 12-color system */
            color: #4A3C00;
            transform: scale(1.05);
        }

        .word-segment.vietnamese-word {
            font-weight: 600;
        }

        .word-segment.english-word {
            font-style: italic;
        }

        /* Phrase break indicators */
        .phrase-break {
            margin: 8px 0;
            height: 1px;
            background: linear-gradient(to right, transparent, #3498db, transparent);
            opacity: 0.3;
        }

        /* Learning Features for Foreign Students */
        .pronunciation-guide {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            border-radius: 4px;
            padding: 8px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 14px;
            color: #B8860B;
        }

        .pronunciation-button {
            background: #52BE80; /* 12-color system green */
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 5px;
            transition: background 0.2s ease;
        }

        .pronunciation-button:hover {
            background: #27AE60;
        }

        .word-tooltip {
            position: relative;
            display: inline-block;
        }

        .word-tooltip .tooltip-content {
            visibility: hidden;
            width: 200px;
            background-color: #2C3E50;
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.3;
        }

        .word-tooltip .tooltip-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2C3E50 transparent transparent transparent;
        }

        .word-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }


        .cultural-story {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(155, 89, 182, 0.1));
            border-left: 4px solid #9B59B6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .cultural-story h5 {
            color: #9B59B6;
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .learning-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .learning-button {
            background: #3498DB; /* 12-color system blue */
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .learning-button:hover {
            background: #2980B9;
            transform: translateY(-1px);
        }

        .learning-button.active {
            background: #E74C3C;
        }

        .phonetic-display {
            font-family: 'Segoe UI', sans-serif;
            color: #7F8C8D;
            font-style: italic;
            margin-top: 5px;
            font-size: 14px;
        }

        .vocabulary-highlight {
            border-bottom: 2px dotted #3498DB;
            cursor: help;
        }

        /* Progress tracking for learners */
        .learning-progress {
            background: #ECF0F1;
            height: 4px;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #27AE60, #3498DB);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Responsive design for lyrics */
        @media (max-width: 768px) {
            .lyrics-dual-column {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .vietnamese-column {
                text-align: left;
            }

            .phrase-line {
                margin-bottom: 8px;
            }

            .learning-controls {
                justify-content: center;
            }

            .word-tooltip .tooltip-content {
                width: 150px;
                margin-left: -75px;
            }
        }

        .panel-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .panel-header:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f99);
        }

        .panel-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .collapse-indicator {
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .panel-header.collapsed .collapse-indicator {
            transform: rotate(-90deg);
        }

        .panel-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .panel-content.collapsed {
            max-height: 0;
        }

        .panel-content.expanded {
            max-height: 1000px;
        }

        .tuning-info {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--panel-border, #e0e0e0);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tuning-display {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            color: #008080; /* 12-color system teal */
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .bent-notes-count {
            font-size: 14px;
            color: #e74c3c; /* 12-color system red */
            font-weight: 600;
            background: #fff5f5;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #fecaca;
        }

        /* Tablature Container Styles */
        .tablature-container {
            padding: 20px;
            overflow-x: auto;
            background: #fafafa;
        }

        .optimal-tablature {
            border-top: 3px solid #27ae60; /* Green for optimal */
        }

        .comparison-tablature {
            border-top: 3px solid #e74c3c; /* Red for comparison */
        }

        /* Tuning Dropdown */
        .tuning-dropdown {
            padding: 15px 20px;
            background: #f0f0f0;
            border-bottom: 1px solid var(--panel-border, #e0e0e0);
        }

        .tuning-dropdown label {
            font-weight: 600;
            color: var(--text-primary, #2c3e50);
            margin-right: 10px;
        }

        .tuning-dropdown select {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 14px;
            color: var(--text-primary, #2c3e50);
            cursor: pointer;
        }

        /* SVG and Note Styling - v3.5.8 compliance */
        .note-circle {
            fill: #666666; /* Neutral grey - identical across all tunings */
            stroke: #333333;
            stroke-width: 1;
            transition: all 0.2s ease;
        }

        .bent-indicator {
            fill: #FF0000;
            font-size: 10px;
            font-weight: bold;
        }

        .bent-line {
            stroke: #FF0000;
            stroke-width: 1.5;
            stroke-dasharray: 3,2;
            fill: none;
        }

        .string-line {
            stroke: #000000;
            stroke-width: 3;
            opacity: 1;
        }

        .string-line.unused {
            stroke: #999999;
            opacity: 0.3;
        }

        /* Control styles */
        .controls {
            background: var(--panel-bg, white);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .zoom-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zoom-control label {
            font-weight: 600;
            color: var(--text-primary, #2c3e50);
            min-width: 80px;
        }

        .zoom-slider {
            width: 150px;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3498db; /* 12-color system blue */
            cursor: pointer;
        }

        .zoom-value {
            font-family: monospace;
            font-weight: bold;
            color: var(--text-primary, #2c3e50);
            min-width: 50px;
        }

        button {
            background: #3498db; /* 12-color system blue */
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        button:hover {
            background: #2980b9;
        }

        button.toggle-active {
            background: #e74c3c; /* 12-color system red */
        }

        button.toggle-active:hover {
            background: #c0392b;
        }

        /* Back to Library button */
        .back-button {
            background: #27ae60; /* 12-color system green */
            margin-left: auto;
        }

        .back-button:hover {
            background: #219a52;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .zoom-control {
                justify-content: space-between;
            }
        }

    </style>
</head>
<body class="theme-white">
    <div class="container">
        <!-- Theme Selector -->
        <div class="theme-selector">
            <select id="themeSelector" onchange="changeTheme(this.value)">
                <option value="white">White</option>
                <option value="light-grey">Light Grey</option>
                <option value="dark-grey">Dark Grey</option>
                <option value="black">Black</option>
            </select>
        </div>

        <!-- Header -->
        <header>
            <h1>B√† r·∫±ng b√† r√≠</h1>
            <h2>Tuning Analysis Comparison</h2>
        </header>

        <!-- Controls -->
        <div class="controls">
            <div class="zoom-control">
                <label>X-Zoom:</label>
                <input type="range" id="xZoomSlider" class="zoom-slider" min="1" max="500" value="100"
                       oninput="updateXZoom(this.value)">
                <span class="zoom-value" id="xZoomValue">100%</span>
                <button onclick="fitWidth()">Fit Width</button>
            </div>

            <div class="zoom-control">
                <label>Y-Zoom:</label>
                <input type="range" id="yZoomSlider" class="zoom-slider" min="1" max="500" value="100"
                       oninput="updateYZoom(this.value)">
                <span class="zoom-value" id="yZoomValue">100%</span>
                <button onclick="fitHeight()">Fit Height</button>
            </div>

            <button class="back-button" onclick="window.location.href='/library'">‚Üê Back to Library</button>
        </div>

        <!-- Dual-Panel Tuning Analyzer System -->
        <div class="tuning-analyzer-container">

            <!-- Top Panel: Optimal Tuning -->
            <div class="tuning-panel" id="optimalPanel">
                <div class="panel-header" onclick="togglePanel('optimal')">
                    <h3>üéµ Optimal Tuning (Song-Specific)</h3>
                    <span class="collapse-indicator" id="optimalCollapse">‚ñº</span>
                </div>
                <div class="panel-content expanded" id="optimalContent">
                    <div class="tuning-info">
                        <span class="tuning-display" id="optimalTuning">C-D-E-G-A</span>
                        <span class="bent-notes-count" id="optimalBentCount">8 bent notes (6%)</span>
                        <button id="optimalBentToggle" onclick="toggleBentNotesPanel('optimal')" style="margin-left: 20px;">üéØ Bent Notes</button>
                    </div>
                    <div class="tablature-container optimal-tablature">
                        <svg width="2000" height="400" xmlns="http://www.w3.org/2000/svg"
                             id="optimalTablatureSvg" data-base-width="2000">
                            <rect x="100" y="50" width="1800" height="3" fill="#000" /><text x="50" y="65" fill="#2c3e50" text-anchor="middle" font-size="14px" font-weight="bold">Demo</text>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Bottom Panel: Comparison Tuning -->
            <div class="tuning-panel" id="comparisonPanel">
                <div class="panel-header" onclick="togglePanel('comparison')">
                    <h3>üîç Comparison Tuning</h3>
                    <span class="collapse-indicator" id="comparisonCollapse">‚ñº</span>
                </div>
                <div class="panel-content expanded" id="comparisonContent">
                    <div class="tuning-dropdown">
                        <label for="comparisonTuningSelect">Select Tuning:</label>
                        <select id="comparisonTuningSelect" onchange="updateComparisonTuning(this.value)">
                            <option value="traditional">Traditional (C-D-E-G-A)</option>
                            <option value="natural">Natural Major (C-D-E-F-G)</option>
                            <option value="pentatonic">Pentatonic (A-C-D-E-G)</option>
                            <option value="exotic1">Exotic 1 (Eb-G-Ab-Bb-Cb)</option>
                            <option value="exotic2">Exotic 2 (C#-D#-F#-G-G#)</option>
                        </select>
                    </div>
                    <div class="tuning-info">
                        <span class="tuning-display" id="comparisonTuning">C-D-E-G-A</span>
                        <span class="bent-notes-count" id="comparisonBentCount">Loading...</span>
                        <button id="comparisonBentToggle" onclick="toggleBentNotesPanel('comparison')" style="margin-left: 20px;">üéØ Bent Notes</button>
                    </div>
                    <div class="tablature-container comparison-tablature">
                        <svg width="2000" height="400" xmlns="http://www.w3.org/2000/svg"
                             id="comparisonTablatureSvg" data-base-width="2000">
                            <rect x="100" y="50" width="1800" height="3" fill="#999" /><text x="50" y="65" fill="#2c3e50" text-anchor="middle" font-size="14px" font-weight="bold">Demo</text>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Content Information Panel -->
            <div class="lyrics-panel" id="contentPanel">
                <div class="panel-header" onclick="togglePanel('content')">
                    <h3>üìö Song Information & Analysis</h3>
                    <span class="collapse-indicator" id="contentCollapse">‚ñº</span>
                </div>
                <div class="panel-content expanded" id="contentPanelContent">
                    <div class="lyrics-buttons-container">
                        <button class="lyrics-button active" onclick="showContentSection('lyrics')">Lyrics</button>
                        <button class="lyrics-button" onclick="showContentSection('analysis')">Musical Analysis</button>
                        <button class="lyrics-button" onclick="showContentSection('performance')">Performance Notes</button>
                        <button class="lyrics-button" onclick="showContentSection('cultural')">Cultural Context</button>
                        <button class="lyrics-button" onclick="showContentSection('history')">Historical Background</button>
                        <button class="lyrics-button" onclick="showContentSection('variations')">Regional Variations</button>
                    </div>

                    <!-- Lyrics Content -->
                    <div class="lyrics-content visible" id="lyricsContentSection">
                        <h4>Vietnamese Folk Song Lyrics</h4>

                        <!-- Learning Controls for Foreign Students -->
                        <div class="learning-controls">
                            <button class="learning-button" onclick="togglePronunciationGuide()">
                                üîä Pronunciation Guide
                            </button>
                            <button class="learning-button" onclick="toggleVocabularyMode()">
                                üìö Vocabulary Tooltips
                            </button>
                            <button class="learning-button" onclick="showCulturalStories()">
                                üèÆ Cultural Stories
                            </button>
                        </div>

                        <!-- Learning Progress -->
                        <div class="learning-progress">
                            <div class="progress-bar" id="learningProgressBar"></div>
                        </div>

                        <!-- V1-Style Interactive Lyrics Layout -->
                        <div class="v1-lyrics-container">
                            <!-- Column Headers -->
                            <div class="lyrics-headers">
                                <div class="vietnamese-header">Ti·∫øng Vi·ªát (Vietnamese)</div>
                                <div class="english-header">English Translation</div>
                            </div>

                            <!-- Interactive Controls -->
                            <div class="lyrics-controls">
                                <button class="control-btn" onclick="playLyrics()">‚ñ∂Ô∏è</button>
                                <button class="control-btn" onclick="pauseLyrics()">üîÑ</button>
                                <button class="control-btn" onclick="stopLyrics()">‚èπÔ∏è</button>
                                <button class="control-btn" onclick="toggleEditMode()">üìù</button>
                                <button class="control-btn" onclick="toggleTranslation()">üåê</button>
                                <button class="control-btn" onclick="toggleAudio()">üîä</button>
                                <span class="lyrics-note">üìù Interactive Lyrics: Click the "|" symbols to add/remove line breaks.</span>
                            </div>

                            <!-- Lyrics Content -->
                            <div class="lyrics-content-grid">
                                <div class="vietnamese-lyrics" id="vietnameseLyrics">
                                    <!-- Vietnamese pipe-delimited text -->
                                </div>
                                <div class="english-lyrics" id="englishLyrics">
                                    <!-- English translation -->
                                </div>
                            </div>

                            <!-- Bottom Controls -->
                            <div class="lyrics-bottom-controls">
                                <span>üìù Interactive: Click Vietnamese syllables or English words to see translations. Click "|" to adjust line breaks.</span>
                                <div class="font-controls">
                                    <label>Reset Font: <select id="fontFamily"><option>Default</option></select></label>
                                    <label>Size: <select id="fontSize"><option>18px</option></select></label>
                                    <label>üó£Ô∏è Voice: <select id="voice"><option>üë© Female</option></select></label>
                                    <button onclick="startLearning()">‚ñ∂Ô∏è Start Learning</button>
                                    <button onclick="clearAll()">üóë Clear</button>
                                </div>
                            </div>
                        </div>

                        <!-- Pronunciation Guide (hidden by default) -->
                        <div class="pronunciation-guide" id="pronunciationGuide" style="display: none;">
                            <strong>Pronunciation Guide:</strong>
                            <div id="phoneticDisplay" class="phonetic-display"></div>
                        </div>

                        <!-- Cultural Context Stories -->
                        <div class="cultural-story" id="culturalStoryPanel" style="display: none;">
                            <h5>Cultural Context & Story</h5>
                            <div id="culturalStoryContent">
                                This traditional Vietnamese folk song tells the story of love and separation,
                                common themes in Vietnamese literature that reflect the country's history of migration and change.
                            </div>
                        </div>

                    </div>

                    <!-- Musical Analysis Content -->
                    <div class="lyrics-content" id="analysisContentSection">
                        <h4>Musical Structure Analysis</h4>
                        <div class="verse">{{MUSICAL_ANALYSIS}}</div>
                    </div>

                    <!-- Performance Notes Content -->
                    <div class="lyrics-content" id="performanceContentSection">
                        <h4>Performance Techniques & Notes</h4>
                        <div class="verse">{{PERFORMANCE_NOTES}}</div>
                    </div>

                    <!-- Cultural Context Content -->
                    <div class="lyrics-content" id="culturalContentSection">
                        <h4>Cultural Context & Meaning</h4>
                        <div class="verse">{{CULTURAL_CONTEXT}}</div>
                    </div>

                    <!-- Historical Background Content -->
                    <div class="lyrics-content" id="historyContentSection">
                        <h4>Historical Background</h4>
                        <div class="verse">{{HISTORICAL_BACKGROUND}}</div>
                    </div>

                    <!-- Regional Variations Content -->
                    <div class="lyrics-content" id="variationsContentSection">
                        <h4>Regional Variations</h4>
                        <div class="verse">{{REGIONAL_VARIATIONS}}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DanTranhTuningAnalyzer v3.5.8 Framework JavaScript

        // Global spacing consistency: 0.125px per cent (optimized for C1-B8 range)
        const PIXELS_PER_CENT = 0.125;
        const GLOBAL_SPACING_BASE = 20; // Base Y position

        // Song data (to be populated by generator)
        const songData = {
            notes: [],
            metadata: {"songName": "B√† r·∫±ng b√† r√≠"},
            optimalTuning: ["C", "D", "E", "G", "A"],
            comparisonTunings: {}
        };

        // Theme management
        function changeTheme(theme) {
            document.body.className = `theme-${theme}`;
            localStorage.setItem('danTranh_theme', theme);
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('danTranh_theme') || 'white';
        document.body.className = `theme-${savedTheme}`;
        document.getElementById('themeSelector').value = savedTheme;

        // Panel collapse/expand functionality
        function togglePanel(panelType) {
            const content = document.getElementById(`${panelType}Content`) ||
                           document.getElementById(`${panelType}PanelContent`);
            const indicator = document.getElementById(`${panelType}Collapse`);
            const header = document.querySelector(`#${panelType}Panel .panel-header`);

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                indicator.textContent = '‚ñº';
                header.classList.remove('collapsed');
            } else {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                indicator.textContent = '‚ñ∂';
                header.classList.add('collapsed');
            }
        }

        // Content section switching functionality
        function showContentSection(sectionType) {
            // Hide all content sections
            const contentSections = document.querySelectorAll('.lyrics-content');
            contentSections.forEach(section => {
                section.classList.remove('visible');
            });

            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.lyrics-button');
            buttons.forEach(button => {
                button.classList.remove('active');
            });

            // Show selected content section
            const targetSection = document.getElementById(`${sectionType}ContentSection`);
            if (targetSection) {
                targetSection.classList.add('visible');
            }

            // Mark clicked button as active
            event.target.classList.add('active');
        }

        // Zoom functionality
        let currentXZoom = 1.0;
        let currentYZoom = 1.0;

        function updateXZoom(value) {
            currentXZoom = value / 100;
            document.getElementById('xZoomValue').textContent = value + '%';
            applyZoom();
        }

        function updateYZoom(value) {
            currentYZoom = value / 100;
            document.getElementById('yZoomValue').textContent = value + '%';
            applyZoom();
        }

        function applyZoom() {
            const svgs = ['optimalTablatureSvg', 'comparisonTablatureSvg'];

            svgs.forEach(svgId => {
                const svg = document.getElementById(svgId);
                if (!svg) return;

                // Apply zoom transformation
                svg.style.transform = `scaleX(${currentXZoom}) scaleY(${currentYZoom})`;
                svg.style.transformOrigin = '0 0';

                // Update container scroll if needed
                const container = svg.closest('.tablature-container');
                if (container && currentXZoom > 1) {
                    container.style.overflowX = 'auto';
                }
            });
        }

        function fitWidth() {
            const container = document.querySelector('.tablature-container');
            const svg = document.getElementById('optimalTablatureSvg');
            if (!container || !svg) return;

            const containerWidth = container.clientWidth - 40; // Account for padding
            const svgWidth = parseInt(svg.getAttribute('data-base-width'));
            const fitZoom = Math.max(0.1, Math.min(5.0, containerWidth / svgWidth));

            document.getElementById('xZoomSlider').value = Math.round(fitZoom * 100);
            updateXZoom(Math.round(fitZoom * 100));
        }

        function fitHeight() {
            const container = document.querySelector('.tablature-container');
            const svg = document.getElementById('optimalTablatureSvg');
            if (!container || !svg) return;

            const containerHeight = window.innerHeight * 0.4; // 40% of viewport
            const svgHeight = parseInt(svg.getAttribute('height'));
            const fitZoom = Math.max(0.1, Math.min(5.0, containerHeight / svgHeight));

            document.getElementById('yZoomSlider').value = Math.round(fitZoom * 100);
            updateYZoom(Math.round(fitZoom * 100));
        }

        // Bent notes toggle - separate state for each panel
        let optimalBentVisible = false;
        let comparisonBentVisible = false;

        function toggleBentNotesPanel(panelType) {
            if (panelType === 'optimal') {
                optimalBentVisible = !optimalBentVisible;
                const button = document.getElementById('optimalBentToggle');
                const svgId = 'optimalTablatureSvg';  // Use the actual SVG ID

                if (optimalBentVisible) {
                    button.style.background = '#E74C3C';
                    button.style.color = 'white';
                    console.log('Highlighting bent notes in optimal panel');
                    highlightBentNotesInSVG(svgId);
                } else {
                    button.style.background = '#3498db';  // Reset to original blue
                    button.style.color = 'white';
                    console.log('Unhighlighting bent notes in optimal panel');
                    unhighlightBentNotesInSVG(svgId);
                }
            } else if (panelType === 'comparison') {
                comparisonBentVisible = !comparisonBentVisible;
                const button = document.getElementById('comparisonBentToggle');
                const svgId = 'comparisonTablatureSvg';  // Use the actual SVG ID

                if (comparisonBentVisible) {
                    button.style.background = '#E74C3C';
                    button.style.color = 'white';
                    console.log('Highlighting bent notes in comparison panel');
                    highlightBentNotesInSVG(svgId);
                } else {
                    button.style.background = '#3498db';  // Reset to original blue
                    button.style.color = 'white';
                    console.log('Unhighlighting bent notes in comparison panel');
                    unhighlightBentNotesInSVG(svgId);
                }
            }
        }

        function highlightBentNotes() {
            // Find all panels with SVGs
            ['optimalPanel', 'traditionalPanel'].forEach(panelId => {
                const panel = document.getElementById(panelId);
                if (!panel) return;

                const svg = panel.querySelector('svg');
                if (!svg) return;

                // First, identify bent notes by finding bent lines and their target notes
                const bentNotePositions = new Set();

                // Find all bent lines and get their end coordinates
                svg.querySelectorAll('.bent-line').forEach(bentLine => {
                    // Bent lines have x2/y2 attributes pointing to the bent note
                    const x2 = parseFloat(bentLine.getAttribute('x2'));
                    const y2 = parseFloat(bentLine.getAttribute('y2'));
                    if (!isNaN(x2) && !isNaN(y2)) {
                        bentNotePositions.add(`${x2},${y2}`);
                    }
                });

                // Now highlight only the notes that match bent positions
                const allNotes = svg.querySelectorAll('circle.note-circle, circle[fill="#FFD700"]');
                allNotes.forEach(noteCircle => {
                    const cx = parseFloat(noteCircle.getAttribute('cx'));
                    const cy = parseFloat(noteCircle.getAttribute('cy'));
                    const notePos = `${cx},${cy}`;

                    if (bentNotePositions.has(notePos)) {
                        // Save original colors and mark as bent
                        noteCircle.setAttribute('data-original-fill', noteCircle.getAttribute('fill'));
                        noteCircle.setAttribute('data-original-stroke', noteCircle.getAttribute('stroke'));
                        noteCircle.setAttribute('data-is-bent', 'true');

                        // Apply red fill with black outline
                        noteCircle.setAttribute('fill', '#E74C3C');
                        noteCircle.setAttribute('stroke', '#000000');

                        // Find and highlight the associated resonance triangle
                        // Triangles are positioned after their notes and have matching Y position
                        const triangles = svg.querySelectorAll('polygon.resonance-triangle');
                        triangles.forEach(triangle => {
                            const triangleY = parseFloat(triangle.getAttribute('data-note-y'));
                            const triangleX = parseFloat(triangle.getAttribute('data-note-x'));
                            // Check if this triangle belongs to the bent note
                            if (Math.abs(triangleY - cy) < 1 && Math.abs(triangleX - cx) < 1) {
                                triangle.setAttribute('data-original-fill', triangle.getAttribute('fill'));
                                triangle.setAttribute('data-is-bent', 'true');
                                triangle.setAttribute('fill', '#E74C3C');
                            }
                        });
                    }
                });

                // Make bent lines more visible (keep smooth)
                svg.querySelectorAll('.bent-line').forEach(element => {
                    element.style.opacity = '1';
                    element.style.strokeWidth = '2';
                });
            });
        }

        function highlightBentNotesInSVG(svgId) {
            // Highlight bent notes in the specified SVG
            const svg = document.getElementById(svgId);
            if (!svg) {
                console.log('SVG not found:', svgId);
                return;
            }

            // First, identify bent notes by finding bent lines and their target notes
            const bentNotePositions = new Set();

            // Find all bent lines and get their end coordinates
            svg.querySelectorAll('.bent-line').forEach(bentLine => {
                // Bent lines have x2/y2 attributes pointing to the bent note
                const x2 = parseFloat(bentLine.getAttribute('x2'));
                const y2 = parseFloat(bentLine.getAttribute('y2'));
                if (!isNaN(x2) && !isNaN(y2)) {
                    bentNotePositions.add(`${x2},${y2}`);
                }
            });

            console.log(`Found ${bentNotePositions.size} bent note positions in SVG ${svgId}`);

            // Now highlight only the notes that match bent positions
            // Use a broader selector to catch all circles that might be notes
            const allNotes = svg.querySelectorAll('circle');
            let highlightedCount = 0;

            allNotes.forEach(noteCircle => {
                // Skip circles that are not notes (check if they have reasonable radius)
                const r = parseFloat(noteCircle.getAttribute('r'));
                if (r !== 12 && r !== 6) return; // Only process regular notes (r=12) and grace notes (r=6)

                const cx = parseFloat(noteCircle.getAttribute('cx'));
                const cy = parseFloat(noteCircle.getAttribute('cy'));
                const notePos = `${cx},${cy}`;

                if (bentNotePositions.has(notePos)) {
                    // Save original colors only if not already saved
                    if (!noteCircle.hasAttribute('data-original-fill')) {
                        noteCircle.setAttribute('data-original-fill', noteCircle.getAttribute('fill') || '#666666');
                        noteCircle.setAttribute('data-original-stroke', noteCircle.getAttribute('stroke') || '#333333');
                    }
                    noteCircle.setAttribute('data-is-bent', 'true');

                    // Apply red fill with black outline
                    noteCircle.setAttribute('fill', '#E74C3C');
                    noteCircle.setAttribute('stroke', '#000000');
                    highlightedCount++;

                    // Find and highlight the associated resonance triangle
                    // Triangles are positioned after their notes and have matching Y position
                    const triangles = svg.querySelectorAll('polygon');
                    triangles.forEach(triangle => {
                        const triangleY = parseFloat(triangle.getAttribute('data-note-y'));
                        const triangleX = parseFloat(triangle.getAttribute('data-note-x'));
                        // Check if this triangle belongs to the bent note
                        if (Math.abs(triangleY - cy) < 1 && Math.abs(triangleX - cx) < 1) {
                            if (!triangle.hasAttribute('data-original-fill')) {
                                triangle.setAttribute('data-original-fill', triangle.getAttribute('fill') || '#000000');
                            }
                            triangle.setAttribute('data-is-bent', 'true');
                            triangle.setAttribute('fill', '#E74C3C');
                        }
                    });
                }
            });

            console.log(`Highlighted ${highlightedCount} bent notes in SVG ${svgId}`);

            // Make bent lines more visible (keep smooth)
            svg.querySelectorAll('.bent-line').forEach(element => {
                element.style.opacity = '1';
                element.style.strokeWidth = '2';
            });
        }

        function unhighlightBentNotesInSVG(svgId) {
            // Unhighlight bent notes in the specified SVG
            const svg = document.getElementById(svgId);
            if (!svg) {
                console.log('SVG not found:', svgId);
                return;
            }

            // Restore ONLY bent notes to original colors
            const bentNotes = svg.querySelectorAll('circle[data-is-bent="true"]');
            console.log(`Found ${bentNotes.length} bent notes to unhighlight in SVG ${svgId}`);

            bentNotes.forEach(noteCircle => {
                const originalFill = noteCircle.getAttribute('data-original-fill');
                const originalStroke = noteCircle.getAttribute('data-original-stroke');

                // If we have stored original colors, restore them
                // Otherwise set to default black/grey colors
                if (originalFill) {
                    noteCircle.setAttribute('fill', originalFill);
                } else {
                    // Default fill for notes is #666666 (grey) or #FFD700 (gold for grace notes)
                    const isGraceNote = noteCircle.getAttribute('r') === '6';
                    noteCircle.setAttribute('fill', isGraceNote ? '#FFD700' : '#666666');
                }

                if (originalStroke) {
                    noteCircle.setAttribute('stroke', originalStroke);
                } else {
                    // Default stroke is #333333
                    noteCircle.setAttribute('stroke', '#333333');
                }

                // Clean up attributes
                noteCircle.removeAttribute('data-is-bent');
                noteCircle.removeAttribute('data-original-fill');
                noteCircle.removeAttribute('data-original-stroke');
            });

            // Restore resonance triangles for bent notes
            svg.querySelectorAll('polygon[data-is-bent="true"]').forEach(triangle => {
                const originalFill = triangle.getAttribute('data-original-fill');
                if (originalFill) {
                    triangle.setAttribute('fill', originalFill);
                } else {
                    // Default fill for triangles
                    triangle.setAttribute('fill', '#000000');
                }

                // Clean up attributes
                triangle.removeAttribute('data-is-bent');
                triangle.removeAttribute('data-original-fill');
            });

            // Reset bent lines
            svg.querySelectorAll('.bent-line').forEach(element => {
                element.style.opacity = '0.5';
                element.style.strokeWidth = '1';
            });
        }

        function highlightBentNotesInPanel(panelId) {
            // Highlight bent notes only in the specified panel
            const panel = document.getElementById(panelId);
            if (!panel) return;

            const svg = panel.querySelector('svg');
            if (!svg) return;

            // First, identify bent notes by finding bent lines and their target notes
            const bentNotePositions = new Set();

            // Find all bent lines and get their end coordinates
            svg.querySelectorAll('.bent-line').forEach(bentLine => {
                // Bent lines have x2/y2 attributes pointing to the bent note
                const x2 = parseFloat(bentLine.getAttribute('x2'));
                const y2 = parseFloat(bentLine.getAttribute('y2'));
                if (!isNaN(x2) && !isNaN(y2)) {
                    bentNotePositions.add(`${x2},${y2}`);
                }
            });

            // Now highlight only the notes that match bent positions
            // Use a broader selector to catch all circles that might be notes
            const allNotes = svg.querySelectorAll('circle');
            allNotes.forEach(noteCircle => {
                // Skip circles that are not notes (check if they have reasonable radius)
                const r = parseFloat(noteCircle.getAttribute('r'));
                if (r !== 12 && r !== 6) return; // Only process regular notes (r=12) and grace notes (r=6)

                const cx = parseFloat(noteCircle.getAttribute('cx'));
                const cy = parseFloat(noteCircle.getAttribute('cy'));
                const notePos = `${cx},${cy}`;

                if (bentNotePositions.has(notePos)) {
                    // Save original colors only if not already saved
                    if (!noteCircle.hasAttribute('data-original-fill')) {
                        noteCircle.setAttribute('data-original-fill', noteCircle.getAttribute('fill') || '#666666');
                        noteCircle.setAttribute('data-original-stroke', noteCircle.getAttribute('stroke') || '#333333');
                    }
                    noteCircle.setAttribute('data-is-bent', 'true');

                    // Apply red fill with black outline
                    noteCircle.setAttribute('fill', '#E74C3C');
                    noteCircle.setAttribute('stroke', '#000000');

                    // Find and highlight the associated resonance triangle
                    // Triangles are positioned after their notes and have matching Y position
                    const triangles = svg.querySelectorAll('polygon');
                    triangles.forEach(triangle => {
                        const triangleY = parseFloat(triangle.getAttribute('data-note-y'));
                        const triangleX = parseFloat(triangle.getAttribute('data-note-x'));
                        // Check if this triangle belongs to the bent note
                        if (Math.abs(triangleY - cy) < 1 && Math.abs(triangleX - cx) < 1) {
                            if (!triangle.hasAttribute('data-original-fill')) {
                                triangle.setAttribute('data-original-fill', triangle.getAttribute('fill') || '#000000');
                            }
                            triangle.setAttribute('data-is-bent', 'true');
                            triangle.setAttribute('fill', '#E74C3C');
                        }
                    });
                }
            });

            // Make bent lines more visible (keep smooth)
            svg.querySelectorAll('.bent-line').forEach(element => {
                element.style.opacity = '1';
                element.style.strokeWidth = '2';
            });
        }

        function unhighlightBentNotesInPanel(panelId) {
            // Unhighlight bent notes only in the specified panel
            const panel = document.getElementById(panelId);
            if (!panel) {
                console.log('Panel not found:', panelId);
                return;
            }

            const svg = panel.querySelector('svg');
            if (!svg) {
                console.log('SVG not found in panel:', panelId);
                return;
            }

            // Restore ONLY bent notes to original colors
            const bentNotes = svg.querySelectorAll('circle[data-is-bent="true"]');
            console.log(`Found ${bentNotes.length} bent notes to unhighlight in panel ${panelId}`);

            bentNotes.forEach(noteCircle => {
                const originalFill = noteCircle.getAttribute('data-original-fill');
                const originalStroke = noteCircle.getAttribute('data-original-stroke');

                // If we have stored original colors, restore them
                // Otherwise set to default black/grey colors
                if (originalFill) {
                    noteCircle.setAttribute('fill', originalFill);
                } else {
                    // Default fill for notes is #666666 (grey) or #FFD700 (gold for grace notes)
                    const isGraceNote = noteCircle.getAttribute('r') === '6';
                    noteCircle.setAttribute('fill', isGraceNote ? '#FFD700' : '#666666');
                }

                if (originalStroke) {
                    noteCircle.setAttribute('stroke', originalStroke);
                } else {
                    // Default stroke is #333333
                    noteCircle.setAttribute('stroke', '#333333');
                }

                // Clean up attributes
                noteCircle.removeAttribute('data-is-bent');
                noteCircle.removeAttribute('data-original-fill');
                noteCircle.removeAttribute('data-original-stroke');
            });

            // Restore resonance triangles for bent notes
            svg.querySelectorAll('polygon[data-is-bent="true"]').forEach(triangle => {
                const originalFill = triangle.getAttribute('data-original-fill');
                if (originalFill) {
                    triangle.setAttribute('fill', originalFill);
                } else {
                    // Default fill for triangles
                    triangle.setAttribute('fill', '#000000');
                }

                // Clean up attributes
                triangle.removeAttribute('data-is-bent');
                triangle.removeAttribute('data-original-fill');
            });

            // Reset bent lines
            svg.querySelectorAll('.bent-line, path[class*="bent"]').forEach(element => {
                element.style.opacity = '0.5';
                element.style.strokeWidth = '1';
            });
        }

        function unhighlightBentNotes(panelId) {
            // Unhighlight bent notes only in the specified panel
            const panel = document.getElementById(panelId);
            if (!panel) return;

            const svg = panel.querySelector('svg');
            if (!svg) return;

            // Restore ONLY bent notes to original colors
            const bentNotes = svg.querySelectorAll('circle[data-is-bent="true"]');
            bentNotes.forEach(noteCircle => {
                const originalFill = noteCircle.getAttribute('data-original-fill');
                const originalStroke = noteCircle.getAttribute('data-original-stroke');
                if (originalFill) noteCircle.setAttribute('fill', originalFill);
                if (originalStroke) noteCircle.setAttribute('stroke', originalStroke);

                // Clean up attributes
                noteCircle.removeAttribute('data-is-bent');
                noteCircle.removeAttribute('data-original-fill');
                noteCircle.removeAttribute('data-original-stroke');
            });

            // Restore resonance triangles for bent notes
            svg.querySelectorAll('polygon[data-is-bent="true"]').forEach(triangle => {
                const originalFill = triangle.getAttribute('data-original-fill');
                if (originalFill) triangle.setAttribute('fill', originalFill);

                // Clean up attributes
                triangle.removeAttribute('data-is-bent');
                triangle.removeAttribute('data-original-fill');
            });

            // Reset bent lines
            svg.querySelectorAll('.bent-line, path[class*="bent"]').forEach(element => {
                element.style.opacity = '0.5';
                element.style.strokeWidth = '1';
            });
        }

        // Tuning comparison functionality
        function updateComparisonTuning(tuningKey) {
            const tuningData = songData.comparisonTunings[tuningKey];
            if (!tuningData) return;

            // Update tuning display
            document.getElementById('comparisonTuning').textContent = tuningData.notes.join('-');
            document.getElementById('comparisonBentCount').textContent =
                `${tuningData.bentNotes} bent notes (${tuningData.bentPercentage}%)`;

            // Generate new SVG for comparison tuning
            generateComparisonTablature(tuningData);
        }

        // Generate 17-string pattern for any tuning
        function generate17StringPattern(tuningPattern) {
            const strings = [];
            let stringNumber = 1;
            let octave = 3;
            let patternIndex = 0;

            while (stringNumber <= 17) {
                const note = tuningPattern[patternIndex % tuningPattern.length];
                const fullNote = note + octave;
                const cents = calculateCents(fullNote);

                strings.push({
                    number: stringNumber,
                    note: fullNote,
                    y: GLOBAL_SPACING_BASE + (cents / 100) * PIXELS_PER_CENT * 100 // Convert to pixels
                });

                stringNumber++;
                patternIndex++;
                if (patternIndex % tuningPattern.length === 0) octave++;
            }
            return strings;
        }

        // Calculate cents from note (simplified for demo)
        function calculateCents(note) {
            const noteMap = {
                'C': 0, 'C#': 100, 'Db': 100, 'D': 200, 'D#': 300, 'Eb': 300,
                'E': 400, 'F': 500, 'F#': 600, 'Gb': 600, 'G': 700, 'G#': 800,
                'Ab': 800, 'A': 900, 'A#': 1000, 'Bb': 1000, 'B': 1100
            };

            const noteName = note.replace(/[0-9]/g, '');
            const octave = parseInt(note.replace(/[^0-9]/g, '')) || 4;

            return (octave - 4) * 1200 + (noteMap[noteName] || 0);
        }

        // Generate comparison tablature (placeholder - to be implemented by generator)
        function generateComparisonTablature(tuningData) {
            // This will be implemented by the generate-viewer.js to create
            // systematic bent note analysis for the comparison tuning
            console.log('Generating comparison tablature for:', tuningData);
        }

        // Vietnamese Phrase Break Detection System
        function detectVietnamesePhrases(vietnameseText) {
            // Vietnamese linguistic phrase patterns
            const phraseBreakPatterns = [
                /[.!?]/g,  // Strong punctuation
                /[,;]/g,   // Weak punctuation
                /\s+(v√†|hay|ho·∫∑c|nh∆∞ng|m√†|th√¨|n√™n)\s+/g,  // Conjunctions
                /\s+(em|anh|ch·ªã|c√¥|b√°c|√¥ng|b√†)\s+/g,     // Address terms
                /\s+(∆°i|·∫°|nh√©|nha|ƒëi)\s+/g,               // Particles
                /\s+(r·ªìi|xong|ƒë∆∞·ª£c|th√¥i)\s+/g             // Completion markers
            ];

            let phrases = [vietnameseText];

            phraseBreakPatterns.forEach(pattern => {
                const newPhrases = [];
                phrases.forEach(phrase => {
                    const parts = phrase.split(pattern);
                    parts.forEach(part => {
                        if (part.trim()) newPhrases.push(part.trim());
                    });
                });
                phrases = newPhrases;
            });

            return phrases.filter(phrase => phrase.length > 0);
        }

        // Word-by-Word Highlighting System
        function createHighlightedText(text, language, lineIndex) {
            const words = text.trim().split(/\s+/);
            return words.map((word, wordIndex) => {
                const wordId = `word-${language}-${lineIndex}-${wordIndex}`;
                const cleanWord = word.replace(/[.,!?;:]/g, '');
                return `<span class="word-segment ${language}-word"
                              id="${wordId}"
                              data-line="${lineIndex}"
                              data-word="${wordIndex}"
                              data-clean-word="${cleanWord}"
                              onclick="highlightWordPair('${language}', ${lineIndex}, ${wordIndex})"
                              onmouseover="previewWordPair('${language}', ${lineIndex}, ${wordIndex})"
                              onmouseout="clearPreview()">${word}</span>`;
            }).join(' ');
        }

        // Highlight corresponding word pairs
        function highlightWordPair(language, lineIndex, wordIndex) {
            // Clear all existing highlights
            document.querySelectorAll('.word-segment.highlighted').forEach(el => {
                el.classList.remove('highlighted');
            });

            // Highlight the clicked word
            const clickedWord = document.getElementById(`word-${language}-${lineIndex}-${wordIndex}`);
            if (clickedWord) {
                clickedWord.classList.add('highlighted');
            }

            // Find and highlight corresponding word in other language
            const otherLanguage = language === 'vietnamese' ? 'english' : 'vietnamese';
            const correspondingWord = document.getElementById(`word-${otherLanguage}-${lineIndex}-${wordIndex}`);
            if (correspondingWord) {
                correspondingWord.classList.add('highlighted');
            }
        }

        // Preview word pair on hover
        function previewWordPair(language, lineIndex, wordIndex) {
            const otherLanguage = language === 'vietnamese' ? 'english' : 'vietnamese';
            const correspondingWord = document.getElementById(`word-${otherLanguage}-${lineIndex}-${wordIndex}`);
            if (correspondingWord) {
                correspondingWord.style.background = 'rgba(255, 215, 0, 0.2)';
            }
        }

        // Clear hover preview
        function clearPreview() {
            document.querySelectorAll('.word-segment').forEach(el => {
                if (!el.classList.contains('highlighted')) {
                    el.style.background = '';
                }
            });
        }

        // Populate lyrics with dual-column layout
        function populateLyrics(vietnameseText, englishText) {
            const vietnameseColumn = document.getElementById('vietnameseColumn');
            const englishColumn = document.getElementById('englishColumn');

            if (!vietnameseColumn || !englishColumn) return;

            // Detect meaningful phrases
            const vietnamesePhrases = detectVietnamesePhrases(vietnameseText);
            const englishPhrases = englishText.split(/[.!?]+/).map(p => p.trim()).filter(p => p);

            // Ensure equal number of phrases (pad shorter one)
            const maxPhrases = Math.max(vietnamesePhrases.length, englishPhrases.length);
            while (vietnamesePhrases.length < maxPhrases) vietnamesePhrases.push('');
            while (englishPhrases.length < maxPhrases) englishPhrases.push('');

            let vietnameseHTML = '';
            let englishHTML = '';

            for (let i = 0; i < maxPhrases; i++) {
                // Vietnamese phrase (right-aligned)
                if (vietnamesePhrases[i]) {
                    const vietnameseHighlighted = createHighlightedText(vietnamesePhrases[i], 'vietnamese', i);
                    vietnameseHTML += `
                        <div class="phrase-line">
                            <div class="vietnamese-phrase">${vietnameseHighlighted}</div>
                        </div>
                    `;
                }

                // English phrase (left-aligned)
                if (englishPhrases[i]) {
                    const englishHighlighted = createHighlightedText(englishPhrases[i], 'english', i);
                    englishHTML += `
                        <div class="phrase-line">
                            <div class="english-phrase">${englishHighlighted}</div>
                        </div>
                    `;
                }

                // Add phrase break if not the last item
                if (i < maxPhrases - 1) {
                    vietnameseHTML += '<div class="phrase-break"></div>';
                    englishHTML += '<div class="phrase-break"></div>';
                }
            }

            vietnameseColumn.innerHTML = vietnameseHTML;
            englishColumn.innerHTML = englishHTML;
        }

        // Vietnamese Word Dictionary for Learning
        const vietnameseVocabulary = {
            'ƒë√≤': {
                meaning: 'ferry boat',
                pronunciation: 'doh',
                difficulty: 'easy',
                cultural: 'Traditional Vietnamese ferries were essential for river crossings'
            },
            'ƒë∆∞a': {
                meaning: 'to take, to bring',
                pronunciation: 'doo-ah',
                difficulty: 'easy',
                cultural: 'A gentle verb expressing care and guidance'
            },
            'quan h·ªç': {
                meaning: 'folk song genre',
                pronunciation: 'kwan ho',
                difficulty: 'hard',
                cultural: 'UNESCO-recognized traditional music from northern Vietnam'
            },
            'b√°t': {
                meaning: 'bowl',
                pronunciation: 'baht',
                difficulty: 'easy',
                cultural: 'Often refers to rice bowls, central to Vietnamese meals'
            },
            'n∆∞·ªõc': {
                meaning: 'water',
                pronunciation: 'nook',
                difficulty: 'medium',
                cultural: 'Water is sacred in Vietnamese culture, symbol of life'
            },
            'tr√¥i': {
                meaning: 'to float, to drift',
                pronunciation: 'troy',
                difficulty: 'medium',
                cultural: 'Represents the passage of time and change'
            },
            'anh': {
                meaning: 'older brother/you (male)',
                pronunciation: 'ahn',
                difficulty: 'easy',
                cultural: 'Respectful way to address men, showing hierarchy'
            },
            'em': {
                meaning: 'younger sibling/you (female)',
                pronunciation: 'em',
                difficulty: 'easy',
                cultural: 'Affectionate term, often used between lovers'
            },
            't√¨nh': {
                meaning: 'love, affection',
                pronunciation: 'tinh',
                difficulty: 'medium',
                cultural: 'Deep emotional connection, beyond physical attraction'
            }
        };

        // Learning Mode States
        let learningModes = {
            pronunciationGuide: false,
            vocabularyMode: false,
            culturalStories: false
        };

        // Enhanced word creation with learning features
        function createLearningWord(word, language, lineIndex, wordIndex) {
            const cleanWord = word.replace(/[.,!?;:]/g, '');
            let wordHtml = word;

            if (language === 'vietnamese' && learningModes.vocabularyMode && vietnameseVocabulary[cleanWord]) {
                const vocab = vietnameseVocabulary[cleanWord];
                wordHtml = `
                    <span class="word-tooltip vocabulary-highlight">
                        ${word}
                        <span class="tooltip-content">
                            <strong>${cleanWord}</strong><br>
                            Meaning: ${vocab.meaning}<br>
                            Pronunciation: /${vocab.pronunciation}/<br>
                            Cultural: ${vocab.cultural}
                        </span>
                    </span>
                `;
            }


            const wordId = `word-${language}-${lineIndex}-${wordIndex}`;
            return `<span class="word-segment ${language}-word"
                          id="${wordId}"
                          data-line="${lineIndex}"
                          data-word="${wordIndex}"
                          data-clean-word="${cleanWord}"
                          onclick="highlightWordPair('${language}', ${lineIndex}, ${wordIndex})"
                          onmouseover="previewWordPair('${language}', ${lineIndex}, ${wordIndex})"
                          onmouseout="clearPreview()">${wordHtml}</span>`;
        }

        // Toggle pronunciation guide
        function togglePronunciationGuide() {
            learningModes.pronunciationGuide = !learningModes.pronunciationGuide;
            const guide = document.getElementById('pronunciationGuide');
            const button = event.target;

            if (learningModes.pronunciationGuide) {
                guide.style.display = 'block';
                button.classList.add('active');
                updatePronunciationGuide();
            } else {
                guide.style.display = 'none';
                button.classList.remove('active');
            }
            updateLearningProgress();
        }

        // Toggle vocabulary tooltips
        function toggleVocabularyMode() {
            learningModes.vocabularyMode = !learningModes.vocabularyMode;
            const button = event.target;

            if (learningModes.vocabularyMode) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }

            // Refresh lyrics display
            refreshLyricsDisplay();
            updateLearningProgress();
        }


        // Show cultural stories
        function showCulturalStories() {
            learningModes.culturalStories = !learningModes.culturalStories;
            const panel = document.getElementById('culturalStoryPanel');
            const button = event.target;

            if (learningModes.culturalStories) {
                panel.style.display = 'block';
                button.classList.add('active');
                updateCulturalStory();
            } else {
                panel.style.display = 'none';
                button.classList.remove('active');
            }
            updateLearningProgress();
        }

        // Update pronunciation guide
        function updatePronunciationGuide() {
            const display = document.getElementById('phoneticDisplay');
            display.innerHTML = `
                <strong>Vietnamese Pronunciation Tips:</strong><br>
                ‚Ä¢ "ƒê√≤" sounds like "doh" (boat)<br>
                ‚Ä¢ "Quan h·ªç" is "kwan ho" (folk song)<br>
                ‚Ä¢ "N∆∞·ªõc" is "nook" with falling tone (water)<br>
                ‚Ä¢ "T√¨nh" is "tinh" with level tone (love)
            `;
        }

        // Update cultural story content
        function updateCulturalStory() {
            const content = document.getElementById('culturalStoryContent');
            content.innerHTML = `
                <p>This song tells the timeless story of Vietnamese river life. The ferry (ƒë√≤) represents transition and journey,
                while the flowing water symbolizes the passage of time and unchanging love.</p>

                <p>Quan h·ªç is a UNESCO-recognized folk song tradition from B·∫Øc Ninh province, where men and women
                would sing antiphonal verses across rivers, creating poetic dialogues of love and longing.</p>

                <p>The image of floating bowls (b√°t n∆∞·ªõc tr√¥i) comes from traditional festivals where people would
                float small offerings on rivers, making wishes for love and prosperity.</p>
            `;
        }

        // Refresh lyrics display with current learning modes
        function refreshLyricsDisplay() {
            const sampleVietnamese = `
                ƒê√≤ ƒë∆∞a quan h·ªç b√°t n∆∞·ªõc tr√¥i
                Anh ƒë∆∞a em t·ªõi b·∫øn s√¥ng H·ªìi
                N∆∞·ªõc ch·∫£y xi·∫øt v·ªÅ ƒë√¢u c√≥ bi·∫øt
                T√¨nh anh v·ªõi em trƒÉm nƒÉm kh√¥ng v∆°i
            `;

            const sampleEnglish = `
                The ferry carries folk songs and floating bowls
                I take you to the Hoi river dock
                The flowing water knows not where it goes
                My love for you will never fade in a hundred years
            `;

            populateEnhancedLyrics(sampleVietnamese.trim(), sampleEnglish.trim());
        }

        // Enhanced lyrics population with learning features
        function populateEnhancedLyrics(vietnameseText, englishText) {
            const vietnameseColumn = document.getElementById('vietnameseColumn');
            const englishColumn = document.getElementById('englishColumn');

            if (!vietnameseColumn || !englishColumn) return;

            const vietnamesePhrases = detectVietnamesePhrases(vietnameseText);
            const englishPhrases = englishText.split(/[.!?]+/).map(p => p.trim()).filter(p => p);

            const maxPhrases = Math.max(vietnamesePhrases.length, englishPhrases.length);
            while (vietnamesePhrases.length < maxPhrases) vietnamesePhrases.push('');
            while (englishPhrases.length < maxPhrases) englishPhrases.push('');

            let vietnameseHTML = '';
            let englishHTML = '';

            for (let i = 0; i < maxPhrases; i++) {
                if (vietnamesePhrases[i]) {
                    const words = vietnamesePhrases[i].trim().split(/\s+/);
                    const vietnameseHighlighted = words.map((word, wordIndex) =>
                        createLearningWord(word, 'vietnamese', i, wordIndex)
                    ).join(' ');

                    vietnameseHTML += `
                        <div class="phrase-line">
                            <div class="vietnamese-phrase">${vietnameseHighlighted}</div>
                        </div>
                    `;
                }

                if (englishPhrases[i]) {
                    const englishHighlighted = createHighlightedText(englishPhrases[i], 'english', i);
                    englishHTML += `
                        <div class="phrase-line">
                            <div class="english-phrase">${englishHighlighted}</div>
                        </div>
                    `;
                }

                if (i < maxPhrases - 1) {
                    vietnameseHTML += '<div class="phrase-break"></div>';
                    englishHTML += '<div class="phrase-break"></div>';
                }
            }

            vietnameseColumn.innerHTML = vietnameseHTML;
            englishColumn.innerHTML = englishHTML;
        }

        // Update learning progress bar
        function updateLearningProgress() {
            const activeFeatures = Object.values(learningModes).filter(Boolean).length;
            const totalFeatures = Object.keys(learningModes).length;
            const progress = (activeFeatures / totalFeatures) * 100;

            document.getElementById('learningProgressBar').style.width = progress + '%';
        }

        // V1-Style Pipe-Delimited Lyrics System
        function createV1LyricsDisplay() {
            // Sample "B√† r·∫±ng b√† r√≠" lyrics in V1 format
            const vietnameseV1 = "B√† | R·∫±ng | b√† | R√≠, | ·ªöi | r·∫±ng | b√† | ƒëi, | ·ªõi | ƒëi | l√† | ƒë√¢u | b√† | ƒëi | kh·∫Øp | ch·ªën | n·ªëi | d√¢y | t∆° | h·ªìng | c√°i | duy√™n | √¥ng | ch·ªìng | l√†m | kh·ªï | c√°i | ƒë·ªùi | t√¥i | ∆°i | b√† | R√≠ | ∆°i | b√† | R·∫±ng | b√† | R√≠ | ∆°i. | Ch·ªìng | g√¨ | m√† | ch·ªìng | b√©, | b√© | t·∫πo | t√®o | teo, | ch√¢n | ƒëi | c√† | kheo | l√∫c | ƒëi | ph·∫£i | c√µng | l√∫c | kh√≥c | ph·∫£i | b·ªìng | c√°i | duy√™n | √¥ng | ch·ªìng | l√†m | kh·ªï | c√°i | ƒë·ªùi | t√¥i | ∆°i | b√† | R√≠ | ∆°i | b√† | R·∫±ng | b√† | R√≠ | ∆°i. | Ch·ªìng | g√¨ | m√† | ch·ªìng | ng√°y, | ng√°y | o | o | o | ƒê√™m | th·ªùi | n·∫±m | co | l√†m | ƒÉn | l∆∞·ªùi | bi·∫øng | ch·∫≥ng | lo | h·ªçc | h√†nh | c√°i | duy√™n | √¥ng | ch·ªìng | l√†m | kh·ªï | c√°i | ƒë·ªùi | t√¥i, | ∆°i | b√† | R√≠ | ∆°i | b√† | R·∫±ng | b√† | R√≠ | ∆°i | B√† | R·∫±ng | b√†";

            const englishV1 = "Lady | Rang | lady | Ri, | Oh | telling | lady | where-to-go, | oh | going | is | where | lady | goes | everywhere | places | connecting | threads | silk | red | the | destiny | of | husband | making | miserable | the | life | of-mine | oh | lady | Ri | oh | lady | Rang | lady | Ri | oh. | What-husband | what-kind | that | husband | so-small, | small | tiny | skinny | lean, | legs | walking | crooked | limping | when | going | must | carry | when | crying | must | hold | the | destiny | of | husband | making | miserable | the | life | of-mine | oh | lady | Ri | oh | lady | Rang | lady | Ri | oh. | What-husband | what-kind | that | husband | sleepy, | sleepy | oh | oh | oh | At-night | time | lying | curled-up | doing | eating | lazy | reluctant | not | caring | to-study | or-work | the | destiny | of | husband | making | miserable | the | life | of-mine, | oh | lady | Ri | oh | lady | Rang | lady | Ri | oh | Lady | Rang | lady";

            // Create pipe-delimited display
            const vietnameseElement = document.getElementById('vietnameseLyrics');
            const englishElement = document.getElementById('englishLyrics');

            if (vietnameseElement && englishElement) {
                // Convert pipes to clickable separators
                const vietnameseHTML = vietnameseV1.split(' | ').map((word, index) => {
                    return `<span class="word-segment vietnamese-word" data-index="${index}" onclick="highlightWordPair(${index})">${word}</span>`;
                }).join(' <span class="pipe-separator" onclick="toggleLineBreak(this)">|</span> ');

                const englishHTML = englishV1.split(' | ').map((word, index) => {
                    return `<span class="word-segment english-word" data-index="${index}" onclick="highlightWordPair(${index})">${word}</span>`;
                }).join(' <span class="pipe-separator" onclick="toggleLineBreak(this)">|</span> ');

                vietnameseElement.innerHTML = vietnameseHTML;
                englishElement.innerHTML = englishHTML;
            }
        }

        // V1-Style Interactive Functions
        function playLyrics() {
            console.log('Playing lyrics...');
            // Add audio playback functionality
        }

        function pauseLyrics() {
            console.log('Pausing lyrics...');
        }

        function stopLyrics() {
            console.log('Stopping lyrics...');
        }

        function toggleEditMode() {
            console.log('Toggling edit mode...');
            const pipes = document.querySelectorAll('.pipe-separator');
            pipes.forEach(pipe => {
                pipe.style.backgroundColor = pipe.style.backgroundColor ? '' : 'rgba(52, 152, 219, 0.3)';
            });
        }

        function toggleTranslation() {
            const englishLyrics = document.getElementById('englishLyrics');
            englishLyrics.style.display = englishLyrics.style.display === 'none' ? 'block' : 'none';
        }

        function toggleAudio() {
            console.log('Toggling audio...');
        }

        function toggleLineBreak(pipeElement) {
            const nextElement = pipeElement.nextElementSibling;
            if (nextElement && nextElement.tagName === 'BR') {
                nextElement.remove();
            } else {
                pipeElement.insertAdjacentHTML('afterend', '<br>');
            }
        }

        function highlightWordPair(index) {
            // Clear all highlights
            document.querySelectorAll('.word-segment.highlighted').forEach(el => {
                el.classList.remove('highlighted');
            });

            // Highlight both Vietnamese and English words at same index
            const vietnameseWord = document.querySelector(`.vietnamese-word[data-index="${index}"]`);
            const englishWord = document.querySelector(`.english-word[data-index="${index}"]`);

            if (vietnameseWord) vietnameseWord.classList.add('highlighted');
            if (englishWord) englishWord.classList.add('highlighted');
        }

        function startLearning() {
            console.log('Starting learning mode...');
            // Enable all learning features
            togglePronunciationGuide();
            toggleVocabularyMode();
            showCulturalStories();
        }

        function clearAll() {
            // Clear all highlights and reset
            document.querySelectorAll('.word-segment.highlighted').forEach(el => {
                el.classList.remove('highlighted');
            });
        }

        // Initialize lyrics system with V1 features
        function initializeLyricsSystem() {
            createV1LyricsDisplay();
            updateLearningProgress();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial zoom
            applyZoom();

            // Hide bent notes initially
            hideBentNotes();

            // Initialize comparison tuning
            updateComparisonTuning('traditional');

            // Initialize lyrics system
            initializeLyricsSystem();

            console.log('DanTranhTuningAnalyzer v3.5.8 Framework initialized with lyrics system');
        });
    </script>
</body>
</html>